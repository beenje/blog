<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="http://beenje.github.io/blog/">
<meta name="description" content="Notes to myself">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tchut-Tchut Blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://beenje.github.io/blog/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/uwsgi-send_file-and-python35/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://beenje.github.io/blog/">

                <span id="blog-title">Tchut-Tchut Blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>
                </li>
<li>
<a href="stories/about/index.html">About</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/uwsgi-send_file-and-python35/" class="u-url">uWSGI, send_file and Python 3.5</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/uwsgi-send_file-and-python35/" rel="bookmark"><time class="published dt-published" datetime="2016-07-05T20:39:29+02:00" title="2016-07-05 20:39">2016-07-05 20:39</time></a></p>
                <p class="commentline">
        
    <a href="posts/uwsgi-send_file-and-python35/#disqus_thread" data-disqus-identifier="cache/posts/uwsgi-send_file-and-python35.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I have a Flask app that returns an in-memory bytes buffer (<a class="reference external" href="https://docs.python.org/3/library/io.html#io.BytesIO">io.Bytesio</a>) using Flask <a class="reference external" href="http://flask.pocoo.org/docs/0.11/api/#flask.send_file">send_file</a> function.</p>
<p>The app is deployed using <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a> behind Nginx.
This was working fine with Python 3.4.</p>
<p>When I updated Python to 3.5, I got the following exception when trying to download a file:</p>
<pre class="literal-block">
io.UnsupportedOperation: fileno

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1817, in wsgi_app
    response = self.full_dispatch_request()
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1477, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1381, in handle_user_exception
    reraise(exc_type, exc_value, tb)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/_compat.py", line 33, in reraise
    raise value
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1475, in full_dispatch_request
    rv = self.dispatch_request()
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1461, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask_login.py", line 758, in decorated_view
    return func(*args, **kwargs)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask_security/decorators.py", line 194, in decorated_view
    return fn(*args, **kwargs)
  File "/webapps/bowser/bowser/app/bext/views.py", line 116, in download
    as_attachment=True)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/helpers.py", line 523, in send_file
    data = wrap_file(request.environ, file)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/werkzeug/wsgi.py", line 726, in wrap_file
    return environ.get('wsgi.file_wrapper', FileWrapper)(file, buffer_size)
SystemError: &lt;built-in function uwsgi_sendfile&gt; returned a result with an error set
</pre>
<p>I quickly found the following <a class="reference external" href="http://lists.unbit.it/pipermail/uwsgi/2015-September/008186.html">post</a> with the same exception, but no answer...
A little more googling brought me to this github issue: <a class="reference external" href="https://github.com/unbit/uwsgi/issues/1126">In python3, uwsgi fails to respond a
stream from BytesIO object</a></p>
<p>As described, you should run uwsgi with the <cite>--wsgi-disable-file-wrapper</cite> flag to avoid this problem.
As with all command line options, you can add the following entry in your
uwsgi.ini file:</p>
<pre class="literal-block">
wsgi-disable-file-wrapper = true
</pre>
<p>Note that <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a> 2.0.12 is required.</p>
<p>When searching in <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a> documentation, I only found one match in <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/Changelog-2.0.12.html?highlight=wsgi-disable-file-wrapper">uWSGI 2.0.12 release notes</a>.</p>
<p>A problem/option that should be better documented. Probably a pull request to open :-)</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gitlab-ci-and-conda/" class="u-url">GitLab CI and conda</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/gitlab-ci-and-conda/" rel="bookmark"><time class="published dt-published" datetime="2016-05-31T16:48:23+02:00" title="2016-05-31 16:48">2016-05-31 16:48</time></a></p>
                <p class="commentline">
        
    <a href="posts/gitlab-ci-and-conda/#disqus_thread" data-disqus-identifier="cache/posts/gitlab-ci-and-conda.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I setup GitLab to host several projects at work and I have been quite
pleased with it. I read that setting GitLab CI for test and deployment was
easy so I decided to try it to automatically run the test suite and the
sphinx documentation.</p>
<p>I found the official <a class="reference external" href="http://docs.gitlab.com/ce/ci/quick_start/README.html">documentation</a> to be quite good
to setup a runner so I won't go into details here. I chose the <a class="reference external" href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/executors/docker.md">Docker
executor</a>.</p>
<p>Here is my first <cite>.gitlab-ci.yml</cite> test:</p>
<pre class="literal-block">
image: python:3.4

before_script:
  - pip install -r requirements.txt

tests:
  stage: test
  script:
    - python -m unittest discover -v
</pre>
<p>Success, it works! Nice. But... 8 minutes 33 seconds build time for a test suite that
runs in less than 1 second... that's a bit long.</p>
<p>Let's try using some caching to avoid having to download all the pip
requirements every time. After googling, I found this <a class="reference external" href="https://fleschenberg.net/gitlab-pip-cache/">post</a> explaining that the cache
path must be inside the build directory:</p>
<pre class="literal-block">
image: python:3.4

before_script:
  - export PIP_CACHE_DIR="pip-cache"
  - pip install -r requirements.txt

cache:
  paths:
    - pip-cache

tests:
  stage: test
  script:
    - python -m unittest discover -v
</pre>
<p>With the pip cache, the build time went down to about 6 minutes. A bit
better, but far from acceptable.</p>
<p>Of course I knew the problem was not the download, but the
installation of the pip requirements. I use <a class="reference external" href="http://pandas.pydata.org">pandas</a>
which explains why it takes a while to compile.</p>
<p>So how do you install <a class="reference external" href="http://pandas.pydata.org">pandas</a> easily? With <a class="reference external" href="http://conda.pydata.org/docs/">conda</a> of course!
There are even some nice <a class="reference external" href="https://github.com/ContinuumIO/docker-images">docker images</a>  created by Continuum Analytics ready to be used.</p>
<p>So let's try again:</p>
<pre class="literal-block">
image: continuumio/miniconda3:latest

before_script:
  - conda env create -f environment.yml
  - source activate koopa

tests:
  stage: test
  script:
    - python -m unittest discover -v
</pre>
<p>Build time: 2 minutes 55 seconds. Nice but we need some cache to avoid
downloading all the packages everytime.
The first problem is that the cache path has to be in the build directory.
Conda packages are saved in <cite>/opt/conda/pkgs</cite> by default. A solution is to
replace that directory with a link to a local directory. It works but the
problem is that Gitlab makes a compressed archive to save and restore the
cache which takes quite some time in this case...</p>
<p>How to get a fast cache? Let's use a docker volume!
I modified my <cite>/etc/gitlab-runner/config.toml</cite> to add two volumes:</p>
<pre class="literal-block">
[runners.docker]
  tls_verify = false
  image = "continuumio/miniconda3:latest"
  privileged = false
  disable_cache = false
  volumes = ["/cache", "/opt/cache/conda/pkgs:/opt/conda/pkgs:rw", "/opt/cache/pip:/opt/cache/pip:rw"]
</pre>
<p>One volume for <a class="reference external" href="http://conda.pydata.org/docs/">conda</a> packages and one for <cite>pip</cite>.
My new <cite>.gitlab-ci.yml</cite>:</p>
<pre class="literal-block">
image: continuumio/miniconda3:latest

before_script:
  - export PIP_CACHE_DIR="/opt/cache/pip"
  - conda env create -f environment.yml
  - source activate koopa

tests:
  stage: test
  script:
    - python -m unittest discover -v
</pre>
<p>The build time is about 10 seconds!</p>
<p>Just a few days after my tests, GitLab announced <a class="reference external" href="https://about.gitlab.com/2016/05/23/gitlab-container-registry/">GitLab Container
Registry</a>.
I already thought about building my own docker image and this new feature
would make it even easier than before. But I would have to remember to update
my image if I change my requirements. Which I don't have to think about with the
current solution.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/switching-from-git-bigfile-to-git-lfs/" class="u-url">Switching from git-bigfile to git-lfs</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/switching-from-git-bigfile-to-git-lfs/" rel="bookmark"><time class="published dt-published" datetime="2016-01-30T21:55:32+01:00" title="2016-01-30 21:55">2016-01-30 21:55</time></a></p>
                <p class="commentline">
        
    <a href="posts/switching-from-git-bigfile-to-git-lfs/#disqus_thread" data-disqus-identifier="cache/posts/switching-from-git-bigfile-to-git-lfs.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>In 2012, I was looking for a way to store big files in git. <a class="reference external" href="https://git-annex.branchable.com">git-annex</a>
was already around, but I found it a bit too complex for my use case.
I discovered <a class="reference external" href="https://github.com/schacon/git-media">git-media</a> from Scott Chacon and it looked like what I was looking for.
It was in Ruby which made it not super easy to install on some machines at work.
I thought it was a good exercise to port it to Python. That's how <a class="reference external" href="https://github.com/beenje/git-bigfile">git-bigfile</a> was born.
It was simple and was doing the job.</p>
<p>Last year, I was thinking about giving it some love: port it to Python 3,
add some unittests... That's about when I switched from <a class="reference external" href="https://gogs.io">Gogs</a>
to <a class="reference external" href="https://about.gitlab.com">Gitlab</a> and read that <a class="reference external" href="https://about.gitlab.com">Gitlab</a> was about to support <a class="reference external" href="https://git-lfs.github.com">git-lfs</a>.</p>
<p>Being developed by GitHub and with <a class="reference external" href="https://about.gitlab.com">Gitlab</a> support, <a class="reference external" href="https://git-lfs.github.com">git-lfs</a> was an
obvious option to replace <a class="reference external" href="https://github.com/beenje/git-bigfile">git-bigfile</a>.</p>
<p>Here is how to switch a project using <a class="reference external" href="https://github.com/beenje/git-bigfile">git-bigfile</a> to <a class="reference external" href="https://git-lfs.github.com">git-lfs</a>:</p>
<ol class="arabic">
<li>
<p class="first">Make a list of all files tracked by git-bigfile:</p>
<pre class="literal-block">
$ git bigfile status | awk '/pushed/ {print $NF}' &gt; /tmp/list
</pre>
</li>
<li>
<p class="first">Edit .gitattributes to replace the filter. Replace <cite>filter=bigfile -crlf</cite> with <cite>filter=lfs diff=lfs merge=lfs -text</cite>:</p>
<pre class="literal-block">
$ cat .gitattributes
*.tar.bz2 filter=lfs diff=lfs merge=lfs -text
*.iso filter=lfs diff=lfs merge=lfs -text
*.img filter=lfs diff=lfs merge=lfs -text
</pre>
</li>
<li>
<p class="first">Remove all big files from the staging area and add them back with git-lfs:</p>
<pre class="literal-block">
$ git rm --cached $(cat /tmp/list)
$ git add .
$ git commit -m "Switch to git-lfs"
</pre>
</li>
<li>
<p class="first">Check that the files were added using git-lfs. You should see something
like that:</p>
<pre class="literal-block">
$ git show HEAD
diff --git a/CentOS_6.4/images/install.img
b/CentOS_6.4/images/install.img
index 227ea55..a9cc6a8 100644
--- a/CentOS_6.4/images/install.img
+++ b/CentOS_6.4/images/install.img
@@ -1 +1,3 @@
-5d243948497ceb9f07b033da62498e52269f4b83
+version https://git-lfs.github.com/spec/v1
+oid
sha256:6fcaac620b82e38e2092a6353ca766a3b01fba7f3fd6a0397c57e979aa293db0
+size 133255168
</pre>
</li>
<li>
<p class="first">Remove git-bigfile cache directory:</p>
<pre class="literal-block">
$ rm -rf .git/bigfile
</pre>
</li>
</ol>
<p>Note: to push files larger than 2.1GB to your gitlab server, wait for this
<a class="reference external" href="https://gitlab.com/gitlab-org/gitlab-ce/issues/12745">fix</a>. Hopefully
it will be in 8.4.3.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/crontab-and-date/" class="u-url">crontab and date</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/crontab-and-date/" rel="bookmark"><time class="published dt-published" datetime="2016-01-18T22:42:39+01:00" title="2016-01-18 22:42">2016-01-18 22:42</time></a></p>
                <p class="commentline">
        
    <a href="posts/crontab-and-date/#disqus_thread" data-disqus-identifier="cache/posts/crontab-and-date.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>The other day, I wanted to add a script to the crontab and to redirect the
output to a file including the current date. Easy. I have used the
<cite>date</cite> command many times in bash script like that:</p>
<pre class="literal-block">
current_date=$(date +"%Y%m%dT%H%M")
</pre>
<p>So I added the following to my crontab:</p>
<pre class="literal-block">
0 1 * * * /usr/local/bin/foo &gt; /tmp/foo.$(date +%Y%m%dT%H%M).log 2&gt;&amp;1
</pre>
<p>And... it didn't work...</p>
<p>I quickly identified that the script was working properly when run from the
crontab (it's easy to get a script working from the prompt, not running
from the crontab due to incorrect PATH). The problem was the redirection
but I couldn't see why.</p>
<p>I googled a bit but didn't find anything...</p>
<p>I finally looked at the man pages:</p>
<pre class="literal-block">
$  man 5 crontab

     ...
     The  ``sixth''  field  (the  rest of the line) specifies the command to be run.  The entire command portion of the line, up to a
     newline or % character...
</pre>
<p>Here it was of course! <cite>%</cite> is a special character. It needs to be escaped:</p>
<pre class="literal-block">
0 1 * * * /usr/local/bin/foo &gt; /tmp/foo.$(date +\%Y\%m\%dT\%H\%M).log 2&gt;&amp;1
</pre>
<p>Lesson to remember: check the man pages before to google!</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/compile-and-install-kodi-on-ipad-without-jailbreak/" class="u-url">Compile and install Kodi on iPad without jailbreak</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/compile-and-install-kodi-on-ipad-without-jailbreak/" rel="bookmark"><time class="published dt-published" datetime="2016-01-10T22:10:42+01:00" title="2016-01-10 22:10">2016-01-10 22:10</time></a></p>
                <p class="commentline">
        
    <a href="posts/compile-and-install-kodi-on-ipad-without-jailbreak/#disqus_thread" data-disqus-identifier="cache/posts/compile-and-install-kodi-on-ipad-without-jailbreak.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>With iOS 9 and Xcode 7 it's finally possible to compile and deploy apps on
your iPhone/iPad with a free Apple developer account (no paid membership
required).</p>
<p>I compiled XBMC/Kodi many times on my mac but had never signed an app with
Xcode before and it took me some time to get it right.
So here are my notes:</p>
<p>First thanks to memphiz for the <a class="reference external" href="http://forum.kodi.tv/showthread.php?tid=239610">iOS9 support</a>!</p>
<p>I compiled from his ios9_workaround branch, but it has been <a class="reference external" href="https://github.com/xbmc/xbmc/pull/8250">merged</a> to
master since:</p>
<pre class="literal-block">
$ git clone https://github.com/xbmc/xbmc.git Kodi
$ cd Kodi
$ git remote add memphiz https://github.com/Memphiz/xbmc.git
$ git fetch memphiz
$ git checkout -b ios9_workaround memphiz/ios9_workaround
</pre>
<p>Follow the instructions from the README.ios file:</p>
<pre class="literal-block">
$ git submodule update --init addons/skin.re-touched
$ cd tools/depends
$ ./bootstrap
$ ./configure --host=arm-apple-darwin
$ make -j4
$ make -j4 -C target/binary-addons
$ cd ../..
$ make -j4 -C tools/depends/target/xbmc
$ make clean
$ make -j4 xcode_depends
</pre>
<p>Start Xcode and open the Kodi project.
Open the Preferences, and add your Apple ID if not already
done:</p>
<img alt="/images/add_account.png" src="images/add_account.png"><p>Select the Kodi-iOS target:</p>
<img alt="/images/kodi_ios_target.png" src="images/kodi_ios_target.png"><p>Change the bundle identifier to something unique and click on <em>Fix Issue</em>
to create a provisioning profile.</p>
<img alt="/images/bundle_identifier.png" src="images/bundle_identifier.png"><p>Connect your device to your mac and select it:</p>
<img alt="/images/device.png" src="images/device.png"><p>Click on <em>Run</em> to compile and install Kodi on your device!</p>
</div>
    </div>
    </article>
</div>



        
       <script>var disqus_shortname="tchutchut";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:beenje@gmail.com">Benjamin Bertrand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
