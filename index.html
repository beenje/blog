<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Notes to myself">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tchut-Tchut Blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://beenje.github.io/blog/">
<link rel="next" href="index-1.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/dockerfile-anti-patterns-and-best-practices/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://beenje.github.io/blog/">

                <span id="blog-title">Tchut-Tchut Blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>
                </li>
<li>
<a href="stories/about/index.html">About</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/dockerfile-anti-patterns-and-best-practices/" class="u-url">Dockerfile anti-patterns and best practices</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/dockerfile-anti-patterns-and-best-practices/" rel="bookmark"><time class="published dt-published" datetime="2017-03-16T22:10:49+01:00" title="2017-03-16 22:10">2017-03-16 22:10</time></a></p>
                <p class="commentline">
        
    <a href="posts/dockerfile-anti-patterns-and-best-practices/#disqus_thread" data-disqus-identifier="cache/posts/dockerfile-anti-patterns-and-best-practices.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I've been using <a class="reference external" href="https://www.docker.com">Docker</a> for some time now.
There is already a lot of documentation available online but I recently
saw the same "anti-patterns" several times, so I thought it was worth writing a post about
it.</p>
<p>I won't repeat all the <a class="reference external" href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Best practices for writing Dockerfiles</a> here.
You should definitively read that page.</p>
<p>I want to emphasize some things that took me some time to understand.</p>
<div class="section" id="avoid-invalidating-the-cache">
<h2>Avoid invalidating the cache</h2>
<p>Let's take a simple example with a Python application:</p>
<pre class="literal-block">
FROM python:3.6

COPY . /app
WORKDIR /app

RUN pip install -r requirements.txt

ENTRYPOINT ["python"]
CMD ["ap.py"]
</pre>
<p>It's actually an example I have seen several times online.
This looks fine, right?</p>
<p>The problem is that the <em>COPY . /app</em> command will invalidate the cache as
soon as any file in the current directory is updated.
Let's say you just change the <em>README</em> file and run <em>docker build</em> again.
Docker will have to re-install all the requirements because the
<em>RUN pip</em> command is run after the <em>COPY</em> that invalidated the cache.</p>
<p>The requirements should only be re-installed if the <em>requirements.txt</em>
file changes:</p>
<pre class="literal-block">
FROM python:3.6

WORKDIR /app

COPY requirements.txt /app/requirements.txt
RUN pip install -r requirements.txt

COPY . /app

ENTRYPOINT ["python"]
CMD ["ap.py"]
</pre>
<p>With this Dockerfile, the <em>RUN pip</em> command will only be re-run when the
<em>requirements.txt</em> file changes. It will use the cache otherwise.</p>
<p>This is much more efficient and will save you quite some time if you have
many requirements to install.</p>
</div>
<div class="section" id="minimize-the-number-of-layers">
<h2>Minimize the number of layers</h2>
<p>What does that really mean?</p>
<p>Each <a class="reference external" href="https://www.docker.com">Docker</a> image references a list of read-only layers that represent
filesystem differences. Every command in your Dockerfile will create a new
layer.</p>
<p>Let's use the following Dockerfile:</p>
<pre class="literal-block">
FROM centos:7

RUN yum update -y
RUN yum install -y sudo
RUN yum install -y git
RUN yum clean all
</pre>
<p>Build the docker image and check the layers created with the <em>docker history</em> command:</p>
<pre class="literal-block">
$ docker build -t centos-test .
...
$ docker images
REPOSITORY                       TAG                 IMAGE ID            CREATED              SIZE
centos-test                      latest              1fae366a2613        About a minute ago   470 MB
centos                           7                   98d35105a391        24 hours ago         193 MB
$ docker history centos-test
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
1fae366a2613        2 minutes ago       /bin/sh -c yum clean all                        1.67 MB
999e7c7c0e14        2 minutes ago       /bin/sh -c yum install -y git                   133 MB
c97b66528792        3 minutes ago       /bin/sh -c yum install -y sudo                  81 MB
e0c7b450b7a8        3 minutes ago       /bin/sh -c yum update -y                        62.5 MB
98d35105a391        24 hours ago        /bin/sh -c #(nop)  CMD ["/bin/bash"]            0 B
&lt;missing&gt;           24 hours ago        /bin/sh -c #(nop)  LABEL name=CentOS Base ...   0 B
&lt;missing&gt;           24 hours ago        /bin/sh -c #(nop) ADD file:29f66b8b4bafd0f...   193 MB
&lt;missing&gt;           6 months ago        /bin/sh -c #(nop)  MAINTAINER https://gith...   0 B
</pre>
<p>There are two problems with this Dockerfile:</p>
<ol class="arabic simple">
<li>We added too many layers for nothing.</li>
<li>The <em>yum clean all</em> command is meant to reduce the size of the image but it
actually does the opposite by adding a new layer!</li>
</ol>
<p>Let's check that by removing the latest command and running the build
again:</p>
<pre class="literal-block">
FROM centos:7

RUN yum update -y
RUN yum install -y sudo
RUN yum install -y git
# RUN yum clean all
</pre>
<pre class="literal-block">
$ docker build -t centos-test .
...
$ docker images
REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE
centos-test                      latest              999e7c7c0e14        11 minutes ago      469 MB
centos                           7                   98d35105a391        24 hours ago        193 MB
</pre>
<p>The new image without the <em>yum clean all</em> command is indeed smaller than the previous image (1.67 MB smaller)!</p>
<p>If you want to remove files, it's important to do that in the same RUN command that created those files.
Otherwise there is no point.</p>
<p>Here is the proper way to do it:</p>
<pre class="literal-block">
FROM centos:7

RUN yum update -y \
  &amp;&amp; yum install -y \
  sudo \
  git \
  &amp;&amp; yum clean all
</pre>
<p>Let's build this new image:</p>
<pre class="literal-block">
$ docker build -t centos-test .
...
$ docker images
REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE
centos-test                      latest              54a328ef7efd        21 seconds ago      265 MB
centos                           7                   98d35105a391        24 hours ago        193 MB
$ docker history centos-test
IMAGE               CREATED              CREATED BY                                      SIZE                COMMENT
54a328ef7efd        About a minute ago   /bin/sh -c yum update -y   &amp;&amp; yum install ...   72.8 MB
98d35105a391        24 hours ago         /bin/sh -c #(nop)  CMD ["/bin/bash"]            0 B
&lt;missing&gt;           24 hours ago         /bin/sh -c #(nop)  LABEL name=CentOS Base ...   0 B
&lt;missing&gt;           24 hours ago         /bin/sh -c #(nop) ADD file:29f66b8b4bafd0f...   193 MB
&lt;missing&gt;           6 months ago         /bin/sh -c #(nop)  MAINTAINER https://gith...   0 B
</pre>
<p>The new image is only 265 MB compared to the 470 MB of the original image.
There isn't much more to say :-)</p>
<p>If you want to know more about images and layers, you should read the
documentation: <a class="reference external" href="https://docs.docker.com/engine/userguide/storagedriver/imagesandcontainers/">Understand images, containers, and storage drivers</a>.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Avoid invalidating the cache:</p>
<ul class="simple">
<li>start your Dockerfile with commands that should not change often</li>
<li>put commands that can often invalidate the cache (like COPY .) as
late as possible</li>
<li>only add the needed files (use a .dockerignore file)</li>
</ul>
<p>Minimize the number of layers:</p>
<ul class="simple">
<li>put related commands in the same RUN instruction</li>
<li>remove files in the same RUN command that created them</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/control-your-accessories-from-home-assistant-with-siri-and-homekit/" class="u-url">Control your accessories from Home Assistant with Siri and HomeKit</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/control-your-accessories-from-home-assistant-with-siri-and-homekit/" rel="bookmark"><time class="published dt-published" datetime="2017-02-16T22:58:56+01:00" title="2017-02-16 22:58">2017-02-16 22:58</time></a></p>
                <p class="commentline">
        
    <a href="posts/control-your-accessories-from-home-assistant-with-siri-and-homekit/#disqus_thread" data-disqus-identifier="cache/posts/control-your-accessories-from-home-assistant-with-siri-and-homekit.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>While reading more about <a class="reference external" href="https://home-assistant.io">Home Assistant</a>, I
discovered it was possible to control your accessories from Home Assistant
with Siri and HomeKit. I decided to give that a try.</p>
<p>This requires to install <a class="reference external" href="https://github.com/nfarina/homebridge">Homebridge</a> and
the <a class="reference external" href="https://github.com/home-assistant/homebridge-homeassistant">homebridge-homeassitant plugin</a>.</p>
<div class="section" id="install-homebridge">
<h2>Install Homebridge</h2>
<p>Homebridge is a lightweight NodeJS server that emulates the iOS HomeKit
API. Let's install it in the same <a class="reference external" href="posts/home-assistant-on-turris-omnia-via-lxc-container">LXC container as Home Assistant</a>:</p>
<pre class="literal-block">
root@turris:~# lxc-attach -n homeassistant
</pre>
<p>I followed the <a class="reference external" href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi">Running HomeBridge on a Raspberry Pi page</a>.</p>
<p>We need curl and git:</p>
<pre class="literal-block">
root@homeassistant:~# apt-get install -y curl git
</pre>
<p>Install Node:</p>
<pre class="literal-block">
root@homeassistant:~# curl -sL https://deb.nodesource.com/setup_6.x | bash -
## Installing the NodeSource Node.js v6.x repo...

## Populating apt-get cache...

root@homeassistant:~# apt-get install -y nodejs
</pre>
<p>Install avahi and other dependencies:</p>
<pre class="literal-block">
root@homeassistant:~# apt-get install -y libavahi-compat-libdnssd-dev
</pre>
<p>Install Homebridge and dependencies still following this <a class="reference external" href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi#install-homebridge-and-dependencies">page</a>.
Note that I had a strange problem here. The <em>npm</em> command didn't produce
any output. I found the same issue on <a class="reference external" href="http://stackoverflow.com/questions/40755598/containers-lxc-attach-and-npm-no-output">stackoverflow</a>
and even an <a class="reference external" href="https://github.com/npm/npm/issues/15681">issue on github</a>.
The workaround is just to open a new terminal...</p>
<pre class="literal-block">
root@homeassistant:~# npm install -g --unsafe-perm homebridge hap-nodejs node-gyp
root@homeassistant:~# cd /usr/lib/node_modules/homebridge/
root@homeassistant:/usr/lib/node_modules/homebridge# npm install --unsafe-perm bignum
root@homeassistant:/usr/lib/node_modules/homebridge# cd ../hap-nodejs/node_modules/mdns/
root@homeassistant:/usr/lib/node_modules/hap-nodejs/node_modules/mdns# node-gyp BUILDTYPE=Release rebuild
</pre>
</div>
<div class="section" id="install-and-configure-homebridge-homeassistant-plugin">
<h2>Install and configure homebridge-homeassistant plugin</h2>
<pre class="literal-block">
root@homeassistant:/usr/lib/node_modules/hap-nodejs/node_modules/mdns# cd
root@homeassistant:~# npm install -g --unsafe-perm homebridge-homeassistant
</pre>
<p>Try to start Homebridge:</p>
<pre class="literal-block">
root@homeassistant:~# su -s /bin/bash homeassistant
homeassistant@homeassistant:~$ homebridge
</pre>
<p>Homebridge won't do anything until you've created a configuration file.
So press CTRL-C and create the file <cite>~/.homebridge/config.json</cite>:</p>
<pre class="literal-block">
homeassistant@homeassistant:~$ cat &lt;&lt;EOF &gt;&gt; ~/.homebridge/config.json
{
  "bridge": {
    "name": "Homebridge",
    "username": "CC:22:3D:E3:CE:30",
    "port": 51826,
    "pin": "031-45-154"
  },

  "platforms": [
    {
      "platform": "HomeAssistant",
      "name": "HomeAssistant",
      "host": "http://localhost:8123",
      "logging": false
    }
 ]
}
EOF
</pre>
<p>Note that you can change the username and pin code.
You will need the PIN code to add the Homebridge accessory to HomeKit.</p>
<p>Check the <a class="reference external" href="https://github.com/home-assistant/homebridge-homeassistant#configuration">Home Assistant plugin page</a>
for more information on how to configure the plugin.</p>
</div>
<div class="section" id="automatically-start-homebridge">
<h2>Automatically start Homebridge</h2>
<p>Let's configure systemd.
Create the file <cite>/etc/systemd/system/home-assistant@homebridge.service</cite>:</p>
<pre class="literal-block">
root@homeassistant:~# cat &lt;&lt;EOF &gt;&gt; /etc/systemd/system/home-assistant@homebridge.service
[Unit]
Description=Node.js HomeKit Server
After=syslog.target network-online.target

[Service]
Type=simple
User=homeassistant
ExecStart=/usr/bin/homebridge -U /home/homeassistant/.homebridge
Restart=on-failure
RestartSec=10
KillMode=process

[Install]
WantedBy=multi-user.target
EOF
</pre>
<p>Enable and launch Homebridge:</p>
<pre class="literal-block">
root@homeassistant:~# systemctl --system daemon-reload
root@homeassistant:~# systemctl enable home-assistant@homebridge
Created symlink from /etc/systemd/system/multi-user.target.wants/home-assistant@homebridge.service to /etc/systemd/system/home-assistant@homebridge.service.
root@homeassistant:~# systemctl start home-assistant@homebridge
</pre>
</div>
<div class="section" id="adding-homebridge-to-ios">
<h2>Adding Homebridge to iOS</h2>
<p>Homebridge and the Home Assistant plugin are now running.
Using the Home app on your iOS device, you should be able to add the accessory "Homebridge".
See <a class="reference external" href="https://github.com/nfarina/homebridge#adding-homebridge-to-ios">Homebridge README</a> for
more information. You will need to enter the <em>PIN code</em> defined in your
<cite>config.json</cite> file.</p>
<p>You should then see the Homebridge bridge on your device:</p>
<img alt="/images/homebridge.png" src="images/homebridge.png"><p>And it will automatically add all the accessories defined in Home Assistant!</p>
<img alt="/images/home_accessories.png" src="images/home_accessories.png"><p>You can now even use Siri to control your devices, like turning ON or OFF the TV VPN.</p>
<img alt="/images/siri_tv_vpn_off.png" src="images/siri_tv_vpn_off.png"><p>Note that I renamed the original switch to make it easier to pronounce.
As described in the <a class="reference external" href="https://github.com/nfarina/homebridge#interacting-with-your-devices">README</a>,
avoid names usually used by Siri like "Radio" or "Sonos".</p>
<p>That's it! Homebridge is really a nice addition to Home Assistant if you have some iOS devices at home.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/docker-and-conda/" class="u-url">Docker and conda</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/docker-and-conda/" rel="bookmark"><time class="published dt-published" datetime="2017-01-28T23:32:56+01:00" title="2017-01-28 23:32">2017-01-28 23:32</time></a></p>
                <p class="commentline">
        
    <a href="posts/docker-and-conda/#disqus_thread" data-disqus-identifier="cache/posts/docker-and-conda.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I just read a blog post about <a class="reference external" href="http://fmgdata.kinja.com/using-docker-with-conda-environments-1790901398">Using Docker with Conda Environments</a>.
I do things slightly differently so I thought I would share an example of
Dockerfile I use:</p>
<pre class="literal-block">
FROM continuumio/miniconda3:latest

# Install extra packages if required
RUN apt-get update &amp;&amp; apt-get install -y \
    xxxxxx \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# Add the user that will run the app (no need to run as root)
RUN groupadd -r myuser &amp;&amp; useradd -r -g myuser myuser

WORKDIR /app

# Install myapp requirements
COPY environment.yml /app/environment.yml
RUN conda config --add channels conda-forge \
    &amp;&amp; conda env create -n myapp -f environment.yml \
    &amp;&amp; rm -rf /opt/conda/pkgs/*

# Install myapp
COPY . /app/
RUN chown -R myuser:myuser /app/*

# activate the myapp environment
ENV PATH /opt/conda/envs/myapp/bin:$PATH
</pre>
<p>I don't run <cite>source activate myapp</cite> but just use <cite>ENV</cite> to update the <cite>PATH</cite>
variable. There is only one environment in the docker image. No need for the extra
checks done by the activate script.</p>
<p>With this Dockerfile, any command will be run in the <cite>myapp</cite>
environment.</p>
<p>Just a few additional notes:</p>
<ol class="arabic simple">
<li>Be sure to only copy the file <cite>environment.yml</cite> before to copy the full
current directory. Otherwise any change in the directory would
invalidate the docker cache.
We only want to re-create the conda environment if <cite>environment.yml</cite>
changes.</li>
<li>I always add the <a class="reference external" href="https://conda-forge.github.io">conda-forge channel</a>.
Check this <a class="reference external" href="https://www.continuum.io/blog/developer-blog/community-conda-forge">post</a>
if you haven't heard of it yet.</li>
<li>I clean some cache (<em>/var/lib/apt/lists/</em> and <em>/opt/conda/pkgs/</em>) to
make the image a bit smaller.</li>
</ol>
<p>I switched from virtualenv to <a class="reference external" href="https://conda.io">conda</a> a while ago and I really enjoy it.
A big thanks to <a class="reference external" href="https://www.continuum.io">Continuum Analytics</a>!</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/home-assistant-on-turris-omnia-via-lxc-container/" class="u-url">Home Assistant on Turris Omnia via LXC container</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/home-assistant-on-turris-omnia-via-lxc-container/" rel="bookmark"><time class="published dt-published" datetime="2017-01-26T22:01:30+01:00" title="2017-01-26 22:01">2017-01-26 22:01</time></a></p>
                <p class="commentline">
        
    <a href="posts/home-assistant-on-turris-omnia-via-lxc-container/#disqus_thread" data-disqus-identifier="cache/posts/home-assistant-on-turris-omnia-via-lxc-container.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>In a previous post, I described <a class="reference external" href="posts/openvpn-source-based-routing">how to install OpenVPN client on a Turris
Omnia router</a>. To start or stop the
client, I was using the command line and mentioned the LuCi Web User
Interface.</p>
<p>Both ways are not super easy and fast to access.
A while ago, I wrote a small <a class="reference external" href="http://flask.pocoo.org">Flask</a> web
application to change some settings in my router. The application just
allowed to click on a button to run a script via ssh on the router.</p>
<p>So I could write a small webapp to do just that.
But I recently read about <a class="reference external" href="https://home-assistant.io">Home Assistant</a>. It's
an open-source home automation platform to track and control your devices
at home. There are many components available, including <a class="reference external" href="https://home-assistant.io/components/switch.command_line/">Command Line
Switch</a> which
looks exactly like what I need.</p>
<p>The Raspberry Pi is a popular device to install Home Assistant.
But my <a class="reference external" href="https://omnia.turris.cz/en/">Turris Omnia</a> is quite powerful for a router with
1 GB of RAM and 8 GB of flash. It's time to use some of that power.</p>
<p>From what I <a class="reference external" href="https://forum.turris.cz/t/home-automation-home-assistant-upgrade/1037">read</a>,
there is an openWrt package of Home Assistant.
I couldn't find it in the Turris Omnia available packages.
Anyway, there is another feature I wanted to try: <a class="reference external" href="https://www.turris.cz/doc/en/howto/lxc">LXC Containers</a>. Home Assistant is a Python
application, so it's easy to install in a linux container and would allow
to easily keep the version up-to-date.</p>
<p>So let's start!</p>
<div class="section" id="create-a-lxc-container">
<h2>Create a LXC container</h2>
<p>As described <a class="reference external" href="https://www.turris.cz/doc/en/howto/lxc">here</a>, you can
create a LXC container via the LuCI web interface or via the command
line:</p>
<pre class="literal-block">
root@turris:~# lxc-create -t download -n homeassistant
Setting up the GPG keyring
Downloading the image index
WARNING: Failed to download the file over HTTPs.
         The file was instead download over HTTP. A server replay attack may be possible!

 ---
 DIST  RELEASE  ARCH  VARIANT  BUILD
 ---
 Turris_OS  stable  armv7l  default  2017-01-22
 Turris_OS  stable  ppc  default  2017-01-22
 Alpine  3.4  armv7l  default  2017-01-22
 Debian  Jessie  armv7l  default  2017-01-22
 Gentoo  stable  armv7l  default  2017-01-22
 openSUSE  13.2  armv7l  default  2017-01-22
 openSUSE  42.2  armv7l  default  2017-01-22
 openSUSE  Tumbleweed  armv7l  default  2017-01-22
 Ubuntu  Xenial  armv7l  default  2017-01-22
 Ubuntu  Yakkety  armv7l  default  2017-01-22
 ---

 Distribution: Debian
 Release: Jessie
 Architecture: armv7l

 Flushing the cache...
 Downloading the image index
 Downloading the rootfs
 Downloading the metadata
 The image cache is now ready
 Unpacking the rootfs

 ---
 Distribution Debian version Jessie was just installed into your
 container.

 Content of the tarballs is provided by third party, thus there is
 no warranty of any kind.
</pre>
<p>As you can see above, I chose a Debian Jessie distribution.</p>
<p>Let's start and enter the container:</p>
<pre class="literal-block">
root@turris:~# lxc-start -n homeassistant
root@turris:~# lxc-attach -n homeassistant
</pre>
<p>Now that we are inside the container, we can first set the root password:</p>
<pre class="literal-block">
root@LXC_NAME:~# passwd
Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
</pre>
<p><em>LXC_NAME</em> is not a super nice hostname. Let's update it:</p>
<pre class="literal-block">
root@LXC_NAME:~# hostnamectl set-hostname homeassistant
Failed to create bus connection: No such file or directory
</pre>
<p>Ok... We have to <a class="reference external" href="http://serverfault.com/questions/685837/how-to-set-the-hostname-for-a-debian-jessie-system">install dbus</a>.
While we are at it, let's install vim because
we'll need it to edit the homeassistant configuration:</p>
<pre class="literal-block">
root@LXC_NAME:~# apt-get update
root@LXC_NAME:~# apt-get upgrade
root@LXC_NAME:~# apt-get install -y dbus vim
</pre>
<p>Setting the hostname now works properly:</p>
<pre class="literal-block">
root@LXC_NAME:~# hostnamectl set-hostname homeassistant
</pre>
<p>We can exit and enter the container again to see the change:</p>
<pre class="literal-block">
root@LXC_NAME:~# exit
root@turris:~# lxc-attach -n homeassistant
root@homeassistant:~#
</pre>
</div>
<div class="section" id="install-home-assistant">
<h2>Install Home Assistant</h2>
<p>Next, we just have to follow the <a class="reference external" href="https://home-assistant.io/getting-started/installation-virtualenv/">Home Assistant installation instructions</a>.
They are well detailed. I'll just quickly repeat them here to make it
easier to follow but you should refer to the official page for any update:</p>
<pre class="literal-block">
root@homeassistant:~# apt-get install python-pip python3-dev
root@homeassistant:~# pip install --upgrade virtualenv
root@homeassistant:~# adduser --system homeassistant
root@homeassistant:~# mkdir /srv/homeassistant
root@homeassistant:~# chown homeassistant /srv/homeassistant
root@homeassistant:~# su -s /bin/bash homeassistant
homeassistant@homeassistant:/root$ virtualenv -p python3 /srv/homeassistant
homeassistant@homeassistant:/root$ source /srv/homeassistant/bin/activate
(homeassistant) homeassistant@homeassistant:/root$ pip3 install --upgrade homeassistant
</pre>
<p>Just run <em>hass</em> to start the application and create the default
configuration:</p>
<pre class="literal-block">
(homeassistant) homeassistant@homeassistant:/root$ hass
</pre>
<p>Press CTRL-C to exit.
Check the created configuration file:
<cite>/home/homeassistant/.homeassistant/configuration.yaml</cite>.</p>
<p>You can comment out the <cite>introduction:</cite> line:</p>
<pre class="literal-block">
# Show links to resources in log and frontend
#introduction:
</pre>
</div>
<div class="section" id="add-a-switch-to-home-assistant">
<h2>Add a switch to Home Assistant</h2>
<p>To start and stop our VPN we define a <a class="reference external" href="https://home-assistant.io/components/switch.command_line/">Command Line Switch</a> that
triggers the openvpn script on the router.
Add the following at the end of the file:</p>
<pre class="literal-block">
switch:
  platform: command_line
  switches:
        atv_vpn:
          command_on: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn start"'
          command_off: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn stop"'
          friendly_name: ATV4 VPN
</pre>
<p>The LXC container is just like another computer (a virtual one) on the local network.
To access the router, we have to ssh to it. For this to work without
requesting a password, we have to generate a ssh key and add the public
key to the authorized_keys file on the router:</p>
<pre class="literal-block">
homeassistant@homeassistant:~$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/homeassistant/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/homeassistant/.ssh/id_rsa.
Your public key has been saved in /home/homeassistant/.ssh/id_rsa.pub.
</pre>
<p>Copy the content of <cite>/home/homeassistant/.ssh/id_rsa.pub</cite> to
<cite>/root/.ssh/authorized_keys</cite> (on the router not inside the container).</p>
<p>With this configuration, the switch will always be off when you restart
Home Assistant. It won't know either if you change the state using the
command line or LuCI web interface.
This can be solved by adding the optional <cite>command_state</cite> line. The
command shall return a result code <em>0</em> if the switch is on.
The openvpn init script on the Turris Omnia doesn't take "status" as
argument. An easy way to check if openvpn is running is to use pgrep.
Our new configuration becomes:</p>
<pre class="literal-block">
switch:
  platform: command_line
  switches:
        atv_vpn:
          command_on: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn start"'
          command_off: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn stop"'
          command_state: 'ssh root@&lt;router IP&gt; "pgrep /usr/sbin/openvpn"'
          friendly_name: ATV4 VPN
</pre>
<p>That's it. The switch state will now properly be updated
even if the VPN is started or stopped without using the application.</p>
<p>If you go to <em>http://&lt;container IP&gt;:8123</em>, you should see something like
that:</p>
<img alt="/images/hass_home.png" src="images/hass_home.png">
</div>
<div class="section" id="automatically-start-home-assistant">
<h2>Automatically start Home Assistant</h2>
<p>Let's configure <a class="reference external" href="https://home-assistant.io/getting-started/autostart-systemd/">systemd</a> to automatically
start the application.
Create the file <cite>/etc/systemd/system/home-assistant@homeassistant.service</cite>:</p>
<pre class="literal-block">
root@homeassistant:~# cat &lt;&lt;EOF &gt;&gt; /etc/systemd/system/home-assistant@homeassistant.service
[Unit]
Description=Home Assistant
After=network.target

[Service]
Type=simple
User=homeassistant
ExecStart=/srv/homeassistant/bin/hass -c "/home/homeassistant/.homeassistant"

[Install]
WantedBy=multi-user.target
EOF
</pre>
<p>Enable and launch Home Assistant:</p>
<pre class="literal-block">
root@homeassistant:~# systemctl --system daemon-reload
root@homeassistant:~# systemctl enable home-assistant@homeassistant
Created symlink from /etc/systemd/system/multi-user.target.wants/home-assistant@homeassistant.service to /etc/systemd/system/home-assistant@homeassistant.service.
root@homeassistant:~# systemctl start home-assistant@homeassistant
</pre>
<p>You can check the logs with:</p>
<pre class="literal-block">
root@homeassistant:~# journalctl -f -u home-assistant@homeassistant
</pre>
<p>We just have to make sure the container starts automatically when we
reboot the router.
Set the following in <cite>/etc/config/lxc-auto</cite>:</p>
<pre class="literal-block">
root@turris:~# cat /etc/config/lxc-auto
config container
  option name homeassistant
  option timeout 60
</pre>
</div>
<div class="section" id="make-it-easy-to-access-home-assistant">
<h2>Make it easy to access Home Assistant</h2>
<p>There is one more thing we want to do: assign a fixed IP to the container.
This can be done like for any machines on the LAN via the <em>DHCP and DNS</em> settings in LuCI interface.
In <em>Static Leases</em>, assign a fixed IP to the container MAC address.</p>
<p>Now that the container has a fixed IP, go to <em>http://&lt;container IP&gt;:8123</em> and
create a bookmark or add an icon to your phone and tablet home screen.
This makes it easy for anyone at home to turn the VPN on and off!</p>
<img alt="/images/hass_icon.png" src="images/hass_icon.png">
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/openvpn-source-based-routing/" class="u-url">OpenVPN source based routing</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/openvpn-source-based-routing/" rel="bookmark"><time class="published dt-published" datetime="2017-01-20T21:46:16+01:00" title="2017-01-20 21:46">2017-01-20 21:46</time></a></p>
                <p class="commentline">
        
    <a href="posts/openvpn-source-based-routing/#disqus_thread" data-disqus-identifier="cache/posts/openvpn-source-based-routing.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I already spoke about installing OpenVPN on a Raspberry Pi in another blog
<a class="reference external" href="posts/installing-openvpn-on-a-raspberry-pi-with-ansible">post</a>.</p>
<p>I only connect to this VPN server to access content that requires a french IP address.
I use OpenVPN Connect App on my iPad and <a class="reference external" href="https://tunnelblick.net">Tunnelblick</a>
on my mac.
It works nicely but how to use this VPN on my Apple TV 4?
There is no VPN client available...</p>
<p>End of last year I finally received my <a class="reference external" href="https://omnia.turris.cz/en/">Turris Omnia</a> that I supported on Indiegogo.
It's a nice router running a free operating system based on
OpenWrt with automatic updates.
If you haven't heard about it, you should check it out.</p>
<div class="section" id="configuring-openvpn-client-on-openwrt">
<h2>Configuring OpenVPN client on OpenWrt</h2>
<p>Installing an OpenVPN client on OpenWrt is not very difficult.
Here is a quick summary.</p>
<ol class="arabic">
<li>
<p class="first">Install <cite>openvpn-openssl</cite> package (via the
webinterface or the command line)</p>
</li>
<li>
<p class="first">I already have a custom client config that I generated with Ansible in
this <a class="reference external" href="posts/installing-openvpn-on-a-raspberry-pi-with-ansible">post</a>.
To use this config, create the file <cite>/etc/config/openvpn</cite>:</p>
<pre class="literal-block">
# cat /etc/config/openvpn
package openvpn

config openvpn myvpn
        # Set to 1 to enable this instance:
        option enabled 1
        # Include OpenVPN configuration
        option config /etc/openvpn/myclientconfig.ovpn
</pre>
</li>
<li>
<p class="first">Add a new interface in <cite>/etc/config/network</cite>:</p>
<pre class="literal-block">
config interface 'myvpn'
       option proto 'none'
       option ifname 'tun0'
</pre>
</li>
<li>
<p class="first">Add a new zone to <cite>/etc/config/firewall</cite>:</p>
<pre class="literal-block">
config zone
        option forward 'REJECT'
        option output 'ACCEPT'
        option name 'VPN_FW'
        option input 'REJECT'
        option masq '1'
        option network 'myvpn'
        option mtu_fix '1'

config forwarding
        option dest 'VPN_FW'
        option src 'lan'
</pre>
</li>
<li>
<p class="first">An easy way to configure DNS servers is to add fixed DNS for the WAN interface of the router.
To use Google DNS, add the following two lines to the wan interface in <cite>/etc/config/network</cite>:</p>
<pre class="literal-block">
# diff -u network.save network
@@ -20,6 +20,8 @@
 config interface 'wan'
         option ifname 'eth1'
         option proto 'dhcp'
+        option peerdns '0'
+        option dns '8.8.8.8 8.8.4.4'
</pre>
</li>
</ol>
<p>If you run <cite>/etc/init.d/openvpn start</cite> with this config, you should connect successfully!
All the traffic will go via the VPN. That's nice but it's not what I want.
I only want my Apple TV traffic to go via the VPN. How to achieve that?</p>
</div>
<div class="section" id="source-based-routing">
<h2>Source based routing</h2>
<p>I quickly found this <a class="reference external" href="https://wiki.openwrt.org/doc/networking/routing">wiki page</a> to implement source
based routing. Exactly what I want. What took me some time to realize is
that before to do that I had to ignore the routes pushed by the server.</p>
<p>With my configuration, when the client connects, the server pushes some
routes among which a default route that makes all the traffic go via the
VPN:</p>
<pre class="literal-block">
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         10.8.0.21       128.0.0.0       UG    0      0        0 tun0
...
</pre>
<p>Ignoring the routes pushed by the server can be done with the <cite>--route-noexec</cite> option.
I tried to add <cite>option route_noexec 1</cite> to my <cite>/etc/config/openvpn</cite> file
but it had no effect. It looks like that when using a custom config, you
can't add other options there. You have to set everything in the custom
config. I added <cite>route-noexec</cite> to  my <cite>/etc/openvpn/myclientconfig.ovpn</cite> file and it worked!
No more route added. No traffic sent via the VPN.</p>
<p>We can now apply the changes described in the <a class="reference external" href="https://wiki.openwrt.org/doc/networking/routing">Routing wiki page</a>.</p>
<ol class="arabic">
<li>
<p class="first">Install the <cite>ip</cite> package</p>
</li>
<li>
<p class="first">Add the <cite>10 vpn</cite> line to <cite>/etc/iproute2/rt_tables</cite> so that it looks like
this:</p>
<pre class="literal-block">
# cat /etc/iproute2/rt_tables
#
# reserved values
#
255  local
254  main
253  default
10   vpn
0    unspec
#
# local
#
#1  inr.ruhep
</pre>
</li>
<li>
<p class="first">We now need to add a new rule and route when starting the client.
We can do so using the openvpn <cite>up</cite> command. Create the <cite>/etc/openvpn/upvpn</cite> script:</p>
<pre class="literal-block">
# cat /etc/openvpn/upvpn
#!/bin/sh

client=192.168.75.20

tun_dev=$1
tun_mtu=$2
link_mtu=$3
ifconfig_local_ip=$4
ifconfig_remote_ip=$5

echo "Routing client $client traffic through VPN"
ip rule add from $client priority 10 table vpn
ip route add $client dev $tun_dev table vpn
ip route add default via $ifconfig_remote_ip dev $tun_dev table vpn
ip route flush cache
</pre>
</li>
<li>
<p class="first">Create the <cite>/etc/openvpn/downvpn</cite> script to properly remove the rule and route:</p>
<pre class="literal-block">
# cat /etc/openvpn/downvpn
#!/bin/sh

client=192.168.75.20

tun_dev=$1
tun_mtu=$2
link_mtu=$3
ifconfig_local_ip=$4
ifconfig_remote_ip=$5

echo "Delete client $client traffic routing through VPN"
ip rule del from $client priority 10 table vpn
ip route del $client dev $tun_dev table vpn
ip route del default via $ifconfig_remote_ip dev $tun_dev table vpn
ip route flush cache
</pre>
</li>
<li>
<p class="first">We now have to add those scripts to the client config.
Here is everything I added to my <cite>/etc/openvpn/myclientconfig.ovpn</cite> file:</p>
<pre class="literal-block">
# Don't add or remove routes automatically
# Source based routing for specific client added in up script
route-noexec
# script-security 2 needed to run up and down scripts
script-security 2
# Script to run after successful TUN/TAP device open
up /etc/openvpn/upvpn
# Call down script before to close TUN to properly remove the routing
down-pre
down /etc/openvpn/downvpn
</pre>
</li>
</ol>
<p>Notice that the machine IP address that we want to route via the VPN is
hard-coded in the the upvpn and downvpn scripts.
This IP shall be fixed. You can easily do that by associating it to
the required MAC address in the DHCP settings.</p>
<p>The tunnel remote IP is automatically passed in parameter to the up and
down scripts by openvpn.</p>
<p>If we run <cite>/etc/init.d/openvpn start</cite> with this config, only the traffic
from the 192.168.75.20 IP address will go via the VPN!</p>
<p>Run <cite>/etc/init.d/openvpn stop</cite> to close the tunnel.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>This is a nice way to route traffic through a VPN based on the source IP
address.</p>
<p>You can of course use the router webinterface to stop and start openvpn.
In <a class="reference external" href="posts/home-assistant-on-turris-omnia-via-lxc-container">another post</a>,
I'll talk about an even more user friendly way to control it.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/parsing-and-indexing-pdf-in-python/" class="u-url">Parsing and indexing PDF in Python</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/parsing-and-indexing-pdf-in-python/" rel="bookmark"><time class="published dt-published" datetime="2016-11-16T21:59:23+01:00" title="2016-11-16 21:59">2016-11-16 21:59</time></a></p>
                <p class="commentline">
        
    <a href="posts/parsing-and-indexing-pdf-in-python/#disqus_thread" data-disqus-identifier="cache/posts/parsing-and-indexing-pdf-in-python.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I have a <a href="http://www.getdoxie.com">Doxie Go</a> scanner and I scan all the documents I receive in paper.
That's nice, but it creates another problem. All the resulting PDF files have to be named, organized and stored...
Doing that manually is boring and time consuming. Of course that's something I want to automate!</p>
<p>I even bought <a href="https://www.noodlesoft.com">Hazel</a> a while ago.
It's a nice software that monitors files in a folder and performs specific instructions based on the rules you defined.
It works well but I felt a bit limited and I thought I could probably write something more tailored to my use case.
And that would be more fun :-)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parsing-PDF-in-Python">Parsing PDF in Python<a class="anchor-link" href="posts/parsing-and-indexing-pdf-in-python/#Parsing-PDF-in-Python">¶</a>
</h2>
<p>A quick solution I found was to run <a href="https://linux.die.net/man/1/pdftotext">pdftotext</a> using subprocess.
I looked at <a href="https://euske.github.io/pdfminer/">PDFMiner</a>, a pure Python PDF parser but I found pdftotext
output to be more accurate.
On MacOS, you can install it using <a href="http://brew.sh">Homebrew</a>:</p>

<pre><code>$ brew install Caskroom/cask/pdftotext</code></pre>
<p>Here is a simple Python function to do that:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">def</span> <span class="nf">parse_pdf</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">"pdftotext"</span><span class="p">,</span> <span class="s1">'-enc'</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Skipping </span><span class="si">{}</span><span class="s1"> (pdftotext returned status </span><span class="si">{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try to parse a pdf file. We'll use <code>requests</code> to download a sample file.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">'http://www.cbu.edu.zm/downloads/pdf-sample.pdf'</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/tmp/pdf-sample.pdf'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's first look at the PDF:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">IFrame</span>
<span class="n">IFrame</span><span class="p">(</span><span class="s1">'http://www.cbu.edu.zm/downloads/pdf-sample.pdf'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">870</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[3]:</div>

<div class="output_html rendered_html output_subarea output_execute_result">

        <iframe width="600" height="870" src="http://www.cbu.edu.zm/downloads/pdf-sample.pdf" frameborder="0" allowfullscreen></iframe>
        
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Nothing complex. It should be easy to parse.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">content</span> <span class="o">=</span> <span class="n">parse_pdf</span><span class="p">(</span><span class="s1">'/tmp/pdf-sample.pdf'</span><span class="p">)</span>
<span class="n">content</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[4]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>"Adobe Acrobat PDF Files\nAdobe® Portable Document Format (PDF) is a universal file format that preserves all of the fonts, formatting, colours and graphics of any source document, regardless of the application and platform used to create it. Adobe PDF is an ideal format for electronic document distribution as it overcomes the problems commonly encountered with electronic file sharing. • Anyone, anywhere can open a PDF file. All you need is the free Adobe Acrobat Reader. Recipients of other file formats sometimes can't open files because they don't have the applications used to create the documents. PDF files always print correctly on any printing device. PDF files always display exactly as created, regardless of fonts, software, and operating systems. Fonts, and graphics are not lost due to platform, software, and version incompatibilities. The free Acrobat Reader is easy to download and can be freely distributed by anyone. Compact PDF files are smaller than their source files and download a page at a time for fast display on the Web.\n\n• •\n\n• •\n\n\x0c"</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This works quite well. The layout is not respected but it's the text that matters. It would be easy to define some regex to define rules based on the PDF content.</p>
<p>This could be the first step in naming and organizing the scanned documents.
But it would be nice to have an interface to easily search in all the files.
I've already used MongoDB full text search in a webapp I wrote and it worked well for my use case.
But I read about Elasticsearch and I always wanted to give it a try.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Elasticsearch-Ingest-Attachment-Processor-Plugin">Elasticsearch Ingest Attachment Processor Plugin<a class="anchor-link" href="posts/parsing-and-indexing-pdf-in-python/#Elasticsearch-Ingest-Attachment-Processor-Plugin">¶</a>
</h2>
<p>I could just index the result from pdftotext, but I know there is a plugin that can parse PDF files.</p>
<p>The <a href="https://github.com/elastic/elasticsearch-mapper-attachments#mapper-attachments-type-for-elasticsearch&gt;">Mapper Attachments Type plugin</a>
is <a href="https://www.elastic.co/guide/en/elasticsearch/plugins/5.x/mapper-attachments.html&gt;">deprecated</a>
in 5.0.0. It has been replaced with the <a href="https://www.elastic.co/guide/en/elasticsearch/plugins/5.x/ingest-attachment.html">ingest-attachment</a>
plugin.
So let's look at that.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Running-Elasticsearch">Running Elasticsearch<a class="anchor-link" href="posts/parsing-and-indexing-pdf-in-python/#Running-Elasticsearch">¶</a>
</h3>
<p>To run Elasticsearch, the easiest is to use Docker.
As the official image from <a href="https://hub.docker.com/_/elasticsearch/">Docker Hub</a> comes with no plugin, we'll
create our own image.
See <a href="https://www.elastic.co/blog/elasticsearch-docker-plugin-management">Elasticsearch Plugin Management with Docker</a>
for more information.</p>
<p>Here is our <code>Dockerfile</code>:</p>

<pre><code>FROM elasticsearch:5

RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install ingest-attachment</code></pre>
<p>Create the <code>elasticsearch-ingest</code> docker image:</p>

<pre><code>$ docker build -t elasticsearch-ingest .</code></pre>
<p>We can now run elasticsearch with the ingest-attachment plugin:</p>

<pre><code>$ docker run -d -p 9200:9200 elasticsearch-ingest</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Python-Elasticsearch-Client">Python Elasticsearch Client<a class="anchor-link" href="posts/parsing-and-indexing-pdf-in-python/#Python-Elasticsearch-Client">¶</a>
</h3>
<p>We'll use <a href="https://elasticsearch-py.readthedocs.io/en/master/">elasticsearch-py</a>
to interact with our Elasticsearch cluster.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="k">import</span> <span class="n">Elasticsearch</span>
<span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's first check that our elasticsearch cluster is alive by asking about its health:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">es</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">health</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[6]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>'1479333419 21:56:59 elasticsearch green 1 1 0 0 0 0 0 0 - 100.0%\n'</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Nice! We can start playing with our ES cluster.</p>
<p>As described in the <a href="https://www.elastic.co/guide/en/elasticsearch/plugins/master/using-ingest-attachment.html">documentation</a>, we first have to create a pipeline to use the Ingest Attachment Processor Plugin:</p>

<pre><code>PUT _ingest/pipeline/attachment
{
  "description" : "Extract attachment information",
  "processors" : [
    {
      "attachment" : {
        "field" : "data"
      }
    }
  ]
}</code></pre>
<p>OK, how do we do that using the Python client?</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"description"</span> <span class="p">:</span> <span class="s2">"Extract attachment information"</span><span class="p">,</span>
  <span class="s2">"processors"</span> <span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">"attachment"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">"field"</span> <span class="p">:</span> <span class="s2">"data"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
<span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'_ingest'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">'pipeline'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">'attachment'</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[7]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'acknowledged': True}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, we can send a document to our pipeline. Let's start by using the same example as in the documentation:</p>

<pre><code>PUT my_index/my_type/my_id?pipeline=attachment
{
  "data": "e1xydGYxXGFuc2kNCkxvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0DQpccGFyIH0="
}</code></pre>
<p>Using Python client, this gives:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result1</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'my_index'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">'my_type'</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">'attachment'</span><span class="p">,</span>
                  <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s1">'data'</span><span class="p">:</span> <span class="s2">"e1xydGYxXGFuc2kNCkxvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0DQpccGFyIH0="</span><span class="p">})</span>
<span class="n">result1</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[8]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'_id': 'AVhvJKzVIvjFWZACJU_t',
 '_index': 'my_index',
 '_shards': {'failed': 0, 'successful': 1, 'total': 2},
 '_type': 'my_type',
 '_version': 1,
 'created': True,
 'result': 'created'}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try to get the created document based on its id:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">es</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'my_index'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">'my_type'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">result1</span><span class="p">[</span><span class="s1">'_id'</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[9]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'_id': 'AVhvJKzVIvjFWZACJU_t',
 '_index': 'my_index',
 '_source': {'attachment': {'content': 'Lorem ipsum dolor sit amet',
   'content_length': 28,
   'content_type': 'application/rtf',
   'language': 'ro'},
  'data': 'e1xydGYxXGFuc2kNCkxvcmVtIGlwc3VtIGRvbG9yIHNpdCBhbWV0DQpccGFyIH0='},
 '_type': 'my_type',
 '_version': 1,
 'found': True}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that the binary data passed to the pipeline was a Rich Text Format file and that the content was extracted: <em>Lorem ipsum dolor sit amet</em></p>
<p>Displaying the binary data is not very useful. It doesn't matter in this example as it's quite small.
But it would be much bigger even on small files. We can exclude it using <code>_source_exclude</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">es</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'my_index'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">'my_type'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">result1</span><span class="p">[</span><span class="s1">'_id'</span><span class="p">],</span> <span class="n">_source_exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[10]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'_id': 'AVhvJKzVIvjFWZACJU_t',
 '_index': 'my_index',
 '_source': {'attachment': {'content': 'Lorem ipsum dolor sit amet',
   'content_length': 28,
   'content_type': 'application/rtf',
   'language': 'ro'}},
 '_type': 'my_type',
 '_version': 1,
 'found': True}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Indexing-PDF-files">Indexing PDF files<a class="anchor-link" href="posts/parsing-and-indexing-pdf-in-python/#Indexing-PDF-files">¶</a>
</h3>
<p>Let's try to parse the same sample pdf as before.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">'http://www.cbu.edu.zm/downloads/pdf-sample.pdf'</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that we have to encode the content of the pdf before to pass it to ES.
The source field must be a base64 encoded binary.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">base64</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'ascii'</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">result2</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'my_index'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">'my_type'</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">'attachment'</span><span class="p">,</span>
                  <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s1">'data'</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>
<span class="n">result2</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[13]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'_id': 'AVhvJMC6IvjFWZACJU_u',
 '_index': 'my_index',
 '_shards': {'failed': 0, 'successful': 1, 'total': 2},
 '_type': 'my_type',
 '_version': 1,
 'created': True,
 'result': 'created'}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can get the document based on its id:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">doc</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'my_index'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">'my_type'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">result2</span><span class="p">[</span><span class="s1">'_id'</span><span class="p">],</span> <span class="n">_source_exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span>
<span class="n">doc</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[14]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'_id': 'AVhvJMC6IvjFWZACJU_u',
 '_index': 'my_index',
 '_source': {'attachment': {'author': 'cdaily',
   'content': "Adobe Acrobat PDF Files\n\nAdobe® Portable Document Format (PDF) is a universal file format that preserves all\nof the fonts, formatting, colours and graphics of any source document, regardless of\nthe application and platform used to create it.\n\nAdobe PDF is an ideal format for electronic document distribution as it overcomes the\nproblems commonly encountered with electronic file sharing.\n\n•  Anyone, anywhere can open a PDF file. All you need is the free Adobe Acrobat\nReader. Recipients of other file formats sometimes can't open files because they\ndon't have the applications used to create the documents.\n\n•  PDF files always print correctly on any printing device.\n\n•  PDF files always display exactly as created, regardless of fonts, software, and\noperating systems. Fonts, and graphics are not lost due to platform, software, and\nversion incompatibilities.\n\n•  The free Acrobat Reader is easy to download and can be freely distributed by\nanyone.\n\n•  Compact PDF files are smaller than their source files and download a\npage at a time for fast display on the Web.",
   'content_length': 1073,
   'content_type': 'application/pdf',
   'date': '2000-06-28T23:21:08Z',
   'language': 'en',
   'title': 'This is a test PDF file'}},
 '_type': 'my_type',
 '_version': 1,
 'found': True}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Or with a basic search:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">es</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">'my_index'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s1">'my_type'</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="s1">'Adobe'</span><span class="p">,</span> <span class="n">_source_exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[15]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'_shards': {'failed': 0, 'successful': 5, 'total': 5},
 'hits': {'hits': [{'_id': 'AVhvJMC6IvjFWZACJU_u',
    '_index': 'my_index',
    '_score': 0.45930308,
    '_source': {'attachment': {'author': 'cdaily',
      'content': "Adobe Acrobat PDF Files\n\nAdobe® Portable Document Format (PDF) is a universal file format that preserves all\nof the fonts, formatting, colours and graphics of any source document, regardless of\nthe application and platform used to create it.\n\nAdobe PDF is an ideal format for electronic document distribution as it overcomes the\nproblems commonly encountered with electronic file sharing.\n\n•  Anyone, anywhere can open a PDF file. All you need is the free Adobe Acrobat\nReader. Recipients of other file formats sometimes can't open files because they\ndon't have the applications used to create the documents.\n\n•  PDF files always print correctly on any printing device.\n\n•  PDF files always display exactly as created, regardless of fonts, software, and\noperating systems. Fonts, and graphics are not lost due to platform, software, and\nversion incompatibilities.\n\n•  The free Acrobat Reader is easy to download and can be freely distributed by\nanyone.\n\n•  Compact PDF files are smaller than their source files and download a\npage at a time for fast display on the Web.",
      'content_length': 1073,
      'content_type': 'application/pdf',
      'date': '2000-06-28T23:21:08Z',
      'language': 'en',
      'title': 'This is a test PDF file'}},
    '_type': 'my_type'}],
  'max_score': 0.45930308,
  'total': 1},
 'timed_out': False,
 'took': 75}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Of course Elasticsearch allows much more complex queries. But that's something for another time.</p>
<p>One interesting thing is that by printing the content, we can see that even the layout is quite acurate! Much better than the pdftotext output:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s1">'_source'</span><span class="p">][</span><span class="s1">'attachment'</span><span class="p">][</span><span class="s1">'content'</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Adobe Acrobat PDF Files

Adobe® Portable Document Format (PDF) is a universal file format that preserves all
of the fonts, formatting, colours and graphics of any source document, regardless of
the application and platform used to create it.

Adobe PDF is an ideal format for electronic document distribution as it overcomes the
problems commonly encountered with electronic file sharing.

•  Anyone, anywhere can open a PDF file. All you need is the free Adobe Acrobat
Reader. Recipients of other file formats sometimes can't open files because they
don't have the applications used to create the documents.

•  PDF files always print correctly on any printing device.

•  PDF files always display exactly as created, regardless of fonts, software, and
operating systems. Fonts, and graphics are not lost due to platform, software, and
version incompatibilities.

•  The free Acrobat Reader is easy to download and can be freely distributed by
anyone.

•  Compact PDF files are smaller than their source files and download a
page at a time for fast display on the Web.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The ingest-attachment plugin uses the Apache text extraction library <a href="http://tika.apache.org">Tika</a>.
It's really powerful. It detects and extracts metadata and text from many file types.</p>
<p>Sending the file directly to Elasticsearch is nice, but in my use case, I'd like to process the file (change its title, move it to a specific location...) based on its content. I could of course update the document in ES after processing it.</p>
<p>It might be better in some case to decorelate the parsing and processing from the indexing.
So let's check how to use Tika from Python.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Apache-Tika">Apache Tika<a class="anchor-link" href="posts/parsing-and-indexing-pdf-in-python/#Apache-Tika">¶</a>
</h2>
<p><a href="https://github.com/chrismattmann/tika-python">Tika-Python</a> makes Apache Tika available as a Python library.
It can even starts a Tika REST server in the background, but this requires Java 7+ to be installed.
I prefer to run the server myself using the prebuilt docker image: <a href="http://logicalspark.github.io/docker-tikaserver/">docker-tikaserver</a>.
Like that I have control of what is running.</p>

<pre><code>$ docker run --rm -p 9998:9998 logicalspark/docker-tikaserver</code></pre>
<p>We can then set Tika-Python to use Client mode only:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tika</span>
<span class="n">tika</span><span class="o">.</span><span class="n">TikaClientOnly</span> <span class="o">=</span> <span class="kc">True</span>
<span class="kn">from</span> <span class="nn">tika</span> <span class="k">import</span> <span class="n">parser</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parsed</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s1">'/tmp/pdf-sample.pdf'</span><span class="p">,</span> <span class="s1">'http://localhost:9998/tika'</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>2016-11-16 22:57:14,233 [MainThread  ] [INFO ]  Starting new HTTP connection (1): localhost
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parsed</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[19]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'content': "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nThis is a test PDF file\n\n\nAdobe Acrobat PDF Files\n\nAdobe® Portable Document Format (PDF) is a universal file format that preserves all\nof the fonts, formatting, colours and graphics of any source document, regardless of\nthe application and platform used to create it.\n\nAdobe PDF is an ideal format for electronic document distribution as it overcomes the\nproblems commonly encountered with electronic file sharing.\n\n•  Anyone, anywhere can open a PDF file. All you need is the free Adobe Acrobat\nReader. Recipients of other file formats sometimes can't open files because they\ndon't have the applications used to create the documents.\n\n•  PDF files always print correctly on any printing device.\n\n•  PDF files always display exactly as created, regardless of fonts, software, and\noperating systems. Fonts, and graphics are not lost due to platform, software, and\nversion incompatibilities.\n\n•  The free Acrobat Reader is easy to download and can be freely distributed by\nanyone.\n\n•  Compact PDF files are smaller than their source files and download a\npage at a time for fast display on the Web.\n\n\n",
 'metadata': {'Author': 'cdaily',
  'Content-Type': 'application/pdf',
  'Creation-Date': '2000-06-28T23:21:08Z',
  'Last-Modified': '2013-10-28T19:24:13Z',
  'Last-Save-Date': '2013-10-28T19:24:13Z',
  'X-Parsed-By': ['org.apache.tika.parser.DefaultParser',
   'org.apache.tika.parser.pdf.PDFParser'],
  'X-TIKA:parse_time_millis': '62',
  'access_permission:assemble_document': 'true',
  'access_permission:can_modify': 'true',
  'access_permission:can_print': 'true',
  'access_permission:can_print_degraded': 'true',
  'access_permission:extract_content': 'true',
  'access_permission:extract_for_accessibility': 'true',
  'access_permission:fill_in_form': 'true',
  'access_permission:modify_annotations': 'true',
  'created': 'Wed Jun 28 23:21:08 UTC 2000',
  'creator': 'cdaily',
  'date': '2013-10-28T19:24:13Z',
  'dc:creator': 'cdaily',
  'dc:format': 'application/pdf; version=1.3',
  'dc:title': 'This is a test PDF file',
  'dcterms:created': '2000-06-28T23:21:08Z',
  'dcterms:modified': '2013-10-28T19:24:13Z',
  'meta:author': 'cdaily',
  'meta:creation-date': '2000-06-28T23:21:08Z',
  'meta:save-date': '2013-10-28T19:24:13Z',
  'modified': '2013-10-28T19:24:13Z',
  'pdf:PDFVersion': '1.3',
  'pdf:docinfo:created': '2000-06-28T23:21:08Z',
  'pdf:docinfo:creator': 'cdaily',
  'pdf:docinfo:creator_tool': 'Microsoft Word 8.0',
  'pdf:docinfo:modified': '2013-10-28T19:24:13Z',
  'pdf:docinfo:producer': 'Acrobat Distiller 4.0 for Windows',
  'pdf:docinfo:title': 'This is a test PDF file',
  'pdf:encrypted': 'false',
  'producer': 'Acrobat Distiller 4.0 for Windows',
  'resourceName': 'pdf-sample.pdf',
  'title': 'This is a test PDF file',
  'xmp:CreatorTool': 'Microsoft Word 8.0',
  'xmpMM:DocumentID': 'uuid:0805e221-80a8-459e-a522-635ed5c1e2e6',
  'xmpTPg:NPages': '1'}}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>This is a test PDF file


Adobe Acrobat PDF Files

Adobe® Portable Document Format (PDF) is a universal file format that preserves all
of the fonts, formatting, colours and graphics of any source document, regardless of
the application and platform used to create it.

Adobe PDF is an ideal format for electronic document distribution as it overcomes the
problems commonly encountered with electronic file sharing.

•  Anyone, anywhere can open a PDF file. All you need is the free Adobe Acrobat
Reader. Recipients of other file formats sometimes can't open files because they
don't have the applications used to create the documents.

•  PDF files always print correctly on any printing device.

•  PDF files always display exactly as created, regardless of fonts, software, and
operating systems. Fonts, and graphics are not lost due to platform, software, and
version incompatibilities.

•  The free Acrobat Reader is easy to download and can be freely distributed by
anyone.

•  Compact PDF files are smaller than their source files and download a
page at a time for fast display on the Web.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Not sure why we get the title of the PDF inside the content.
Anyway the text is extracted properly and we even get a lot of metadata:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">parsed</span><span class="p">[</span><span class="s1">'metadata'</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[21]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>{'Author': 'cdaily',
 'Content-Type': 'application/pdf',
 'Creation-Date': '2000-06-28T23:21:08Z',
 'Last-Modified': '2013-10-28T19:24:13Z',
 'Last-Save-Date': '2013-10-28T19:24:13Z',
 'X-Parsed-By': ['org.apache.tika.parser.DefaultParser',
  'org.apache.tika.parser.pdf.PDFParser'],
 'X-TIKA:parse_time_millis': '62',
 'access_permission:assemble_document': 'true',
 'access_permission:can_modify': 'true',
 'access_permission:can_print': 'true',
 'access_permission:can_print_degraded': 'true',
 'access_permission:extract_content': 'true',
 'access_permission:extract_for_accessibility': 'true',
 'access_permission:fill_in_form': 'true',
 'access_permission:modify_annotations': 'true',
 'created': 'Wed Jun 28 23:21:08 UTC 2000',
 'creator': 'cdaily',
 'date': '2013-10-28T19:24:13Z',
 'dc:creator': 'cdaily',
 'dc:format': 'application/pdf; version=1.3',
 'dc:title': 'This is a test PDF file',
 'dcterms:created': '2000-06-28T23:21:08Z',
 'dcterms:modified': '2013-10-28T19:24:13Z',
 'meta:author': 'cdaily',
 'meta:creation-date': '2000-06-28T23:21:08Z',
 'meta:save-date': '2013-10-28T19:24:13Z',
 'modified': '2013-10-28T19:24:13Z',
 'pdf:PDFVersion': '1.3',
 'pdf:docinfo:created': '2000-06-28T23:21:08Z',
 'pdf:docinfo:creator': 'cdaily',
 'pdf:docinfo:creator_tool': 'Microsoft Word 8.0',
 'pdf:docinfo:modified': '2013-10-28T19:24:13Z',
 'pdf:docinfo:producer': 'Acrobat Distiller 4.0 for Windows',
 'pdf:docinfo:title': 'This is a test PDF file',
 'pdf:encrypted': 'false',
 'producer': 'Acrobat Distiller 4.0 for Windows',
 'resourceName': 'pdf-sample.pdf',
 'title': 'This is a test PDF file',
 'xmp:CreatorTool': 'Microsoft Word 8.0',
 'xmpMM:DocumentID': 'uuid:0805e221-80a8-459e-a522-635ed5c1e2e6',
 'xmpTPg:NPages': '1'}</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="posts/parsing-and-indexing-pdf-in-python/#Conclusion">¶</a>
</h2>
<p>We saw different methods to extract text from PDF in Python.
Depending on what you want to do, one might suit you better. And this was of course not exhaustive.</p>
<p>If you want to index PDFs, Elasticsearch might be all you need.
The ingest-attachment plugin uses <a href="http://tika.apache.org">Apache Tika</a> which is very powerful.</p>
<p>And thanks to <a href="https://github.com/chrismattmann/tika-python">Tika-Python</a>, it's very easy to use Tika directly from Python.
You can let the library starts the server or use Docker to start your own.</p>

</div>
</div>
</div>
    </div>
  </div>

    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/gitlab-container-registry-and-proxy/" class="u-url">GitLab Container Registry and proxy</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/gitlab-container-registry-and-proxy/" rel="bookmark"><time class="published dt-published" datetime="2016-09-21T22:10:06+02:00" title="2016-09-21 22:10">2016-09-21 22:10</time></a></p>
                <p class="commentline">
        
    <a href="posts/gitlab-container-registry-and-proxy/#disqus_thread" data-disqus-identifier="cache/posts/gitlab-container-registry-and-proxy.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="section" id="gitlab-on-synology">
<h2>GitLab on Synology</h2>
<p>I installed GitLab CE on a Synology RackStation RS815+ at work.
It has an Intel Atom C2538 that allows to run <a class="reference external" href="https://www.docker.com">Docker</a> on the NAS.</p>
<p>Official GitLab Community Edition docker images are available on <a class="reference external" href="https://hub.docker.com/r/gitlab/gitlab-ce/">Docker Hub</a>.
The documentation to use the image is quite clear and can be found <a class="reference external" href="https://docs.gitlab.com/omnibus/docker/">here</a>.</p>
<p>The ports 80 and 443 are already used by nginx that comes with <a class="reference external" href="https://www.synology.com/en-global/dsm/6.0">DSM</a>.
I wanted to access GitLab using HTTPS, so I disabled port 443 in nginx
configuration. To do that I had to modify the template
<cite>/usr/syno/share/nginx/WWWService.mustache</cite> and reboot the NAS:</p>
<pre class="code diff"><a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-1"></a><span class="gd">--- WWWService.mustache.org 2016-08-16 23:25:06.000000000 +0100</span>
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-2"></a><span class="gi">+++ WWWService.mustache 2016-09-19 13:53:45.256735700 +0100</span>
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-3"></a><span class="gu">@@ -1,8 +1,6 @@</span>
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-4"></a> server {
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-5"></a>     listen 80 default_server{{#reuseport}} reuseport{{/reuseport}};
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-6"></a>     listen [::]:80 default_server{{#reuseport}} reuseport{{/reuseport}};
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-7"></a><span class="gd">-    listen 443 default_server ssl{{#reuseport}} reuseport{{/reuseport}};</span>
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-8"></a><span class="gd">-    listen [::]:443 default_server ssl{{#reuseport}} reuseport{{/reuseport}};</span>
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-9"></a>
<a name="rest_code_cff8ddd8ef394a489bfa0ff9a3761efd-10"></a>     server_name _;
</pre>
<p>The port 22 is also already used by the ssh daemon so I decided to use
the port 2222. I created the directory <cite>/volume1/docker/gitlab</cite> to store
all GitLab data. Here are the required variables in the
<cite>/volume1/docker/gitlab/config/gitlab.rb</cite> config file:</p>
<pre class="literal-block">
external_url "https://mygitlab.example.com"

## GitLab Shell settings for GitLab
gitlab_rails['gitlab_shell_ssh_port'] = 2222

nginx['enable'] = true
nginx['redirect_http_to_https'] = true
</pre>
<p>And this is how I run the image:</p>
<pre class="literal-block">
docker run --detach \
    --hostname mygitlab.example.com \
    --publish 443:443 --publish 8080:80 --publish 2222:22 \
    --name gitlab \
    --restart always \
    --volume /volume1/docker/gitlab/config:/etc/gitlab \
    --volume /volume1/docker/gitlab/logs:/var/log/gitlab \
    --volume /volume1/docker/gitlab/data:/var/opt/gitlab \
    gitlab/gitlab-ce:latest
</pre>
<p>This has been working fine. Since I heard about <a class="reference external" href="https://about.gitlab.com/2016/05/23/gitlab-container-registry/">GitLab Container Registry</a>,
I've been wanted to give it a try.</p>
</div>
<div class="section" id="id1">
<h2>GitLab Container Registry</h2>
<p>To enable it, I just added to my <cite>gitlab.rb</cite> file the registry url:</p>
<pre class="literal-block">
registry_external_url 'https://mygitlab.example.com:4567'
</pre>
<p>I use the existing GitLab domain and use the port 4567 for the registry.
The TLS certificate and key are in the default path, so no need to specify them.</p>
<p>So let's restart GitLab. Don't forget to publish the new port 4567!</p>
<pre class="literal-block">
$ docker stop gitlab
$ docker rm gitlab
$ docker run --detach \
    --hostname mygitlab.example.com \
    --publish 443:443 --publish 8080:80 --publish 2222:22 \
    --publish 4567:4567 \
    --name gitlab \
    --restart always \
    --volume /volume1/docker/gitlab/config:/etc/gitlab \
    --volume /volume1/docker/gitlab/logs:/var/log/gitlab \
    --volume /volume1/docker/gitlab/data:/var/opt/gitlab \
    gitlab/gitlab-ce:latest
</pre>
<p>Easy! Let's test our new docker registry!</p>
<pre class="literal-block">
$ docker login mygitlab.example.com:4567
Username: user
Password:
Error response from daemon: Get https://mygitlab.example.com:4567/v1/users/: Service Unavailable
</pre>
<p>Hmm... Not super useful error...
I thought about publishing port 4567 in docker, so what is happening?
After looking through the logs, I found <cite>/volume1/docker/gitlab/logs/nginx/gitlab_registry_access.logi</cite>. It's empty...
Let's try curl:</p>
<pre class="literal-block">
$ curl https://mygitlab.example.com:4567/v1/users/

curl: (60) Peer certificate cannot be authenticated with known CA certificates
More details here: http://curl.haxx.se/docs/sslcerts.html

curl performs SSL certificate verification by default, using a "bundle"
 of Certificate Authority (CA) public keys (CA certs). If the default
 bundle file isn't adequate, you can specify an alternate file
 using the --cacert option.
If this HTTPS server uses a certificate signed by a CA represented in
 the bundle, the certificate verification probably failed due to a
 problem with the certificate (it might be expired, or the name might
 not match the domain name in the URL).
If you'd like to turn off curl's verification of the certificate, use
 the -k (or --insecure) option.
</pre>
<p>OK, I have a self-signed certificate. So let's try with <cite>--insecure</cite>:</p>
<pre class="literal-block">
$ curl --insecure https://mygitlab.example.com:4567/v1/users/
404 page not found
</pre>
<p>At least I get an entry in my log file:</p>
<pre class="literal-block">
$ cd /volume1/docker/gitlab
$ cat logs/nginx/gitlab_registry_access.log
xxx.xx.x.x - - [21/Sep/2016:14:24:57 +0000] "GET /v1/users/ HTTP/1.1" 404 19 "-" "curl/7.43.0"
</pre>
<p>So, docker and nginx seem to be configured properly...
It looks like <cite>docker login</cite> is not even trying to access my host...</p>
<p>Let's try with a dummy host:</p>
<pre class="literal-block">
$ docker login foo
Username: user
Password:
Error response from daemon: Get https://mygitlab.example.com:4567/v1/users/: Service Unavailable
</pre>
<p>Same error!
Why is that? I can ping <cite>mygitlab.example.com</cite> and even access nginx on port 4567 (using curl)
inside the docker container...
My machine is on the same network. It can't be a proxy problem. Wait. Proxy?</p>
<p>That's when I remembered I had configured my docker daemon to use a proxy to access the internet!
I created the file <cite>/etc/systemd/system/docker.service.d/http-proxy.conf</cite> with:</p>
<pre class="literal-block">
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080/"
</pre>
<p>Reading the <a class="reference external" href="https://docs.docker.com/engine/admin/systemd/">docker documentation</a>, it's very clear:
<strong>If you have internal Docker registries that you need to contact without proxying you can specify them via the NO_PROXY environment variable</strong></p>
<p>Let's add the NO_PROXY variable:</p>
<pre class="literal-block">
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080/" "NO_PROXY=localhost,127.0.0.1,mygitlab.example.com"
</pre>
<p>Flush the changes and restart the docker daemon:</p>
<pre class="literal-block">
$ sudo systemctl daemon-reload
$ sudo systemctl restart docker
</pre>
<p>Now let's try to login again:</p>
<pre class="literal-block">
$ docker login mygitlab.example.com:4567
Username: user
Password:
Error response from daemon: Get https://mygitlab.example.com:4567/v1/users/: x509: certificate signed by unknown authority
</pre>
<p>This error is easy to fix (after googling). I have to add the self-signed certificate at the OS level.
On my Ubuntu machine:</p>
<pre class="literal-block">
$ sudo cp mygitlab.example.com.crt /usr/local/share/ca-certificates/
$ sudo update-ca-certificates
$ sudo systemctl restart docker

$ docker login mygitlab.example.com:4567
Username: user
Password:
Login Succeeded
</pre>
<p>Yes! :-)</p>
<p>I can now push docker images to my GitLab Container Registry!</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Setting GitLab Container Registry should have been easy but my proxy
settings made me lost quite some time... The proxy environment variables (HTTP_PROXY, NO_PROXY...)
are not taken into account by the docker commands. The docker daemon has to be configured
specifically. Something to remember!</p>
<p>Note that this was with docker 1.11.2. When trying the same command on my Mac with docker 1.12.1, I got a nicer error message:</p>
<pre class="literal-block">
$ docker --version
Docker version 1.12.1, build 6f9534c
$ docker login foo
Username: user
Password:
Error response from daemon: Get https://foo/v1/users/: dial tcp: lookup foo on xxx.xxx.xx.x:53: no such host
</pre>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/running-background-tasks-with-flask-and-rq/" class="u-url">Running background tasks with Flask and RQ</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/running-background-tasks-with-flask-and-rq/" rel="bookmark"><time class="published dt-published" datetime="2016-08-20T23:32:16+02:00" title="2016-08-20 23:32">2016-08-20 23:32</time></a></p>
                <p class="commentline">
        
    <a href="posts/running-background-tasks-with-flask-and-rq/#disqus_thread" data-disqus-identifier="cache/posts/running-background-tasks-with-flask-and-rq.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I wrote several webapps but it took me a while to understand how to run a
long task and get the result back (without blocking the server).
Of course, you should use a task queue like <a class="reference external" href="http://www.celeryproject.org">Celery</a> or <a class="reference external" href="http://python-rq.org">RQ</a>.
It's easy to find examples how to send a task to a queue and... forget
about it. But how do you get the result?</p>
<p>I found a great blog post from Miguel Grinberg:
<a class="reference external" href="http://blog.miguelgrinberg.com/post/using-celery-with-flask">Using Celery With Flask</a>.
It explains how to use ajax to poll the server for status updates.
And I finally got it!
As Miguel's post already detailed <a class="reference external" href="http://www.celeryproject.org">Celery</a>, I wanted to investigate
<a class="reference external" href="http://python-rq.org">RQ</a> (Redis Queue), a simple library to queue job.</p>
<p>As a side note, Miguel's blog is really great. I learned Flask following the <a class="reference external" href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world">The Flask Mega-Tutorial</a>.
If you are starting with Flask, I highly recommend it, as well as the
<a class="reference external" href="http://flaskbook.com">Flask book</a>.</p>
<p>We'll make a simple app with a form to run some actions.</p>
<div class="section" id="first-version-send-a-post-to-the-server-and-wait-for-the-response">
<h2>First version: send a post to the server and wait for the response</h2>
<p>Let's start with some boilerplate code. This is gonna be a very
simple example, but I'll organize it like I use to for a real application
using <a class="reference external" href="http://flask.pocoo.org/docs/0.11/blueprints/">Blueprints</a>, an
<a class="reference external" href="http://flask.pocoo.org/docs/0.11/patterns/appfactories/">application factory</a>
and some extensions (<a class="reference external" href="https://pythonhosted.org/Flask-Bootstrap/">Flask-Bootstrap</a>, <a class="reference external" href="https://flask-script.readthedocs.io/en/latest/">Flask-Script</a> and <a class="reference external" href="http://flask-wtf.readthedocs.io/en/latest/">Flask-WTF</a>):</p>
<pre class="literal-block">
├── Dockerfile
├── LICENSE
├── README.rst
├── app
│   ├── __init__.py
│   ├── extensions.py
│   ├── factory.py
│   ├── main
│   │   ├── __init__.py
│   │   ├── forms.py
│   │   └── views.py
│   ├── settings.py
│   ├── static
│   │   └── css
│   │       └── main.css
│   ├── tasks.py
│   └── templates
│       ├── base.html
│       └── index.html
├── docker-compose.yml
├── environment.yml
├── manage.py
└── uwsgi.py
</pre>
<p>I define all the used extensions in <cite>app/extensions.py</cite>, my application factory in <cite>app/factory.py</cite> and
my default settings in <cite>app/settings.py</cite>. Nothing strange in there. You can refer to the
<a class="reference external" href="https://github.com/beenje/flask-rq-example">GitHub repository</a>.</p>
<p>Here is our main <cite>app/main/views.py</cite>:</p>
<pre class="code python"><a name="rest_code_ec965f0f20b7430198981fdab669c825-1"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-2"></a><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">tasks</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-3"></a><span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">TaskForm</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-4"></a>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-5"></a><span class="n">bp</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'main'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-6"></a>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-7"></a>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-8"></a><span class="nd">@bp.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-9"></a><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-10"></a>    <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">()</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-11"></a>    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-12"></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">data</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-13"></a>        <span class="k">try</span><span class="p">:</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-14"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-15"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-16"></a>            <span class="n">flash</span><span class="p">(</span><span class="s">'Task failed: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s">'danger'</span><span class="p">)</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-17"></a>        <span class="k">else</span><span class="p">:</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-18"></a>            <span class="n">flash</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">'success'</span><span class="p">)</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-19"></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'main.index'</span><span class="p">))</span>
<a name="rest_code_ec965f0f20b7430198981fdab669c825-20"></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre>
<p>As said previously, we create a form. On submit, we run the task and send the response back.</p>
<p>The form is defined in <cite>app/main/forms.py</cite>:</p>
<pre class="code python"><a name="rest_code_8cc6739fd94746a593a5c00352718761-1"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-2"></a><span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">Form</span>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-3"></a><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">SelectField</span>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-4"></a>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-5"></a>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-6"></a><span class="k">class</span> <span class="nc">TaskForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-7"></a>    <span class="n">task</span> <span class="o">=</span> <span class="n">SelectField</span><span class="p">(</span><span class="s">'Task'</span><span class="p">)</span>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-8"></a>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-9"></a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-10"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a name="rest_code_8cc6739fd94746a593a5c00352718761-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TASKS'</span><span class="p">]]</span>
</pre>
<p>In <cite>app/tasks.py</cite>, we have our <cite>run</cite> function to start a dummy task:</p>
<pre class="code python"><a name="rest_code_655a586d1944498b88ebb1a2dbedd109-1"></a><span class="kn">import</span> <span class="nn">random</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-2"></a><span class="kn">import</span> <span class="nn">time</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-3"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-4"></a>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-5"></a>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-6"></a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-7"></a>    <span class="k">if</span> <span class="s">'error'</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-8"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-9"></a>        <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-10"></a>    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'Short'</span><span class="p">):</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-11"></a>        <span class="n">seconds</span> <span class="o">=</span> <span class="mi">1</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-12"></a>    <span class="k">else</span><span class="p">:</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-13"></a>        <span class="n">seconds</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'MAX_TIME_TO_WAIT'</span><span class="p">])</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-14"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
<a name="rest_code_655a586d1944498b88ebb1a2dbedd109-15"></a>    <span class="k">return</span> <span class="s">'{} performed in {} second(s)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span>
</pre>
<p>In <cite>app/templates/base.html</cite>, we define a fixed to top navbar and
a container to show flash messages and our main code. Note that we take advantage of
<a class="reference external" href="https://pythonhosted.org/Flask-Bootstrap/">Flask-Bootstrap</a>.</p>
<pre class="code html"><a name="rest_code_fa9c151cb92b456aa01b836005c296b8-1"></a>{%- extends "bootstrap/base.html" %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-2"></a>{% import "bootstrap/utils.html" as utils %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-3"></a>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-4"></a>{% block head %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-5"></a>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-6"></a>  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-7"></a>  {{super()}}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-8"></a>{% endblock %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-9"></a>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-10"></a>{% block styles %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-11"></a>  {{super()}}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-12"></a>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"{{ url_for('static', filename='css/main.css') }}"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-13"></a>{% endblock %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-14"></a>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-15"></a>{% block title %}My App{% endblock %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-16"></a>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-17"></a>{% block navbar %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-18"></a>  <span class="c">&lt;!-- Fixed navbar --&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-19"></a>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar navbar-default navbar-fixed-top"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-20"></a>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-21"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-header"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-22"></a>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"navbar-toggle"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">".navbar-collapse"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-23"></a>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span>Toggle navigation<span class="nt">&lt;/span&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-24"></a>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-25"></a>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-26"></a>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-bar"</span><span class="nt">&gt;&lt;/span&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-27"></a>        <span class="nt">&lt;/button&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-28"></a>        <span class="c">&lt;!--img class="navbar-brand" src="../../static/logo.png"--&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-29"></a>        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"{{ url_for('main.index') }}"</span><span class="nt">&gt;</span>My App<span class="nt">&lt;/a&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-30"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-31"></a>    <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-32"></a>  <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-33"></a>{% endblock %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-34"></a>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-35"></a>{% block content %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-36"></a>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span> <span class="na">id=</span><span class="s">"mainContent"</span><span class="nt">&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-37"></a>    {{utils.flashed_messages(container=False, dismissible=True)}}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-38"></a>    {% block main %}{% endblock %}
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-39"></a>  <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_fa9c151cb92b456aa01b836005c296b8-40"></a>{% endblock %}
</pre>
<p>The html code for our view is in <cite>app/templates/index.html</cite>:</p>
<pre class="code html"><a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-1"></a>{%- extends "base.html" %}
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-2"></a>{% import "bootstrap/wtf.html" as wtf %}
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-3"></a>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-4"></a>{% block main %}
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-5"></a>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"panel panel-default"</span><span class="nt">&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-6"></a>        <span class="c">&lt;!-- Default panel contents --&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-7"></a>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"panel-heading"</span><span class="nt">&gt;</span>Select task to run<span class="nt">&lt;/div&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-8"></a>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"panel-body"</span><span class="nt">&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-9"></a>          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-3"</span><span class="nt">&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-10"></a>            <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form"</span> <span class="na">id=</span><span class="s">"taskForm"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-11"></a>              {{ form.hidden_tag() }}
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-12"></a>              {{ wtf.form_field(form.task) }}
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-13"></a>              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-14"></a>                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-default"</span> <span class="na">id=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Run<span class="nt">&lt;/button&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-15"></a>              <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-16"></a>            <span class="nt">&lt;/form&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-17"></a>          <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-18"></a>        <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-19"></a>      <span class="nt">&lt;/div&gt;</span>
<a name="rest_code_8f05c92515134d53b4373a29b0a72a8d-20"></a>{% endblock %}
</pre>
<p>Let's run this first example. We could just create a virtual environment using <a class="reference external" href="https://virtualenv.pypa.io/en/stable/">virtualenv</a>
or <a class="reference external" href="http://conda.pydata.org/docs/intro.html">conda</a>. As we'll soon need <a class="reference external" href="http://redis.io">Redis</a>, let's directly go for <a class="reference external" href="https://www.docker.com">Docker</a>:</p>
<pre class="literal-block">
$ git clone https://github.com/beenje/flask-rq-example.git
$ cd flask-rq-example
$ git checkout faa61009dbe3bafe49aae473f0fa19ab05a3ab90
$ docker-compose build
$ docker-compose up
</pre>
<p>Go to <a class="reference external" href="http://localhost:5000">http://localhost:5000</a>. You should see the following window:</p>
<img alt="/images/flask-rq-example.png" src="images/flask-rq-example.png"><p>Choose a task and press run. See how The UI is stuck while waiting for the server?
Not very nice...
Let' improve that a little by using some JavaScript.</p>
</div>
<div class="section" id="second-version-use-ajax-to-submit-the-form">
<h2>Second version: use Ajax to submit the form</h2>
<p>Let's write some javascript. Here is the <cite>app/static/js/main.js</cite>:</p>
<pre class="code javascript"><a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-1"></a><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-2"></a>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-3"></a>  <span class="c1">// flash an alert</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-4"></a>  <span class="c1">// remove previous alerts by default</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-5"></a>  <span class="c1">// set clean to false to keep old alerts</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-6"></a>  <span class="kd">function</span> <span class="nx">flash_alert</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">category</span><span class="p">,</span> <span class="nx">clean</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-7"></a>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">clean</span><span class="p">)</span> <span class="o">===</span> <span class="s2">"undefined"</span><span class="p">)</span> <span class="nx">clean</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-8"></a>    <span class="k">if</span><span class="p">(</span><span class="nx">clean</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-9"></a>      <span class="nx">remove_alerts</span><span class="p">();</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-10"></a>    <span class="p">}</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-11"></a>    <span class="kd">var</span> <span class="nx">htmlString</span> <span class="o">=</span> <span class="s1">'&lt;div class="alert alert-'</span> <span class="o">+</span> <span class="nx">category</span> <span class="o">+</span> <span class="s1">' alert-dismissible" role="alert"&gt;'</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-12"></a>    <span class="nx">htmlString</span> <span class="o">+=</span> <span class="s1">'&lt;button type="button" class="close" data-dismiss="alert" aria-label="Close"&gt;'</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-13"></a>    <span class="nx">htmlString</span> <span class="o">+=</span> <span class="s1">'&lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;'</span> <span class="o">+</span> <span class="nx">message</span> <span class="o">+</span> <span class="s1">'&lt;/div&gt;'</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-14"></a>    <span class="nx">$</span><span class="p">(</span><span class="nx">htmlString</span><span class="p">).</span><span class="nx">prependTo</span><span class="p">(</span><span class="s2">"#mainContent"</span><span class="p">).</span><span class="nx">hide</span><span class="p">().</span><span class="nx">slideDown</span><span class="p">();</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-15"></a>  <span class="p">}</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-16"></a>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-17"></a>  <span class="kd">function</span> <span class="nx">remove_alerts</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-18"></a>    <span class="nx">$</span><span class="p">(</span><span class="s2">".alert"</span><span class="p">).</span><span class="nx">slideUp</span><span class="p">(</span><span class="s2">"normal"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-19"></a>      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-20"></a>    <span class="p">});</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-21"></a>  <span class="p">}</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-22"></a>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-23"></a>  <span class="c1">// submit form</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-24"></a>  <span class="nx">$</span><span class="p">(</span><span class="s2">"#submit"</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-25"></a>    <span class="nx">flash_alert</span><span class="p">(</span><span class="s2">"Running "</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"#task"</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">+</span> <span class="s2">"..."</span><span class="p">,</span> <span class="s2">"info"</span><span class="p">);</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-26"></a>    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-27"></a>      <span class="nx">url</span><span class="o">:</span> <span class="nx">$SCRIPT_ROOT</span> <span class="o">+</span> <span class="s2">"/_run_task"</span><span class="p">,</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-28"></a>      <span class="nx">data</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">"#taskForm"</span><span class="p">).</span><span class="nx">serialize</span><span class="p">(),</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-29"></a>      <span class="nx">method</span><span class="o">:</span> <span class="s2">"POST"</span><span class="p">,</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-30"></a>      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">"json"</span><span class="p">,</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-31"></a>      <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-32"></a>        <span class="nx">flash_alert</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="s2">"success"</span><span class="p">);</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-33"></a>      <span class="p">},</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-34"></a>      <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-35"></a>        <span class="nx">flash_alert</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">.</span><span class="nx">responseText</span><span class="p">).</span><span class="nx">message</span><span class="p">,</span> <span class="s2">"danger"</span><span class="p">);</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-36"></a>      <span class="p">}</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-37"></a>    <span class="p">});</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-38"></a>  <span class="p">});</span>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-39"></a>
<a name="rest_code_b1174de64191406d824f3d63f2dbe5d7-40"></a><span class="p">});</span>
</pre>
<p>To include this file in our html, we add the following block to <cite>app/templates/base.html</cite>:</p>
<pre class="code html"><a name="rest_code_a7aeddcb475e4b6a8648623dd2eec004-1"></a>{% block scripts %}
<a name="rest_code_a7aeddcb475e4b6a8648623dd2eec004-2"></a>  {{super()}}
<a name="rest_code_a7aeddcb475e4b6a8648623dd2eec004-3"></a>  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">text/javascript</span><span class="nt">&gt;</span>
<a name="rest_code_a7aeddcb475e4b6a8648623dd2eec004-4"></a>    <span class="nx">$SCRIPT_ROOT</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">request</span><span class="p">.</span><span class="nx">script_root</span><span class="o">|</span><span class="nx">tojson</span><span class="o">|</span><span class="nx">safe</span> <span class="p">}};</span>
<a name="rest_code_a7aeddcb475e4b6a8648623dd2eec004-5"></a>  <span class="nt">&lt;/script&gt;</span>
<a name="rest_code_a7aeddcb475e4b6a8648623dd2eec004-6"></a>  {% block app_scripts %}{% endblock %}
<a name="rest_code_a7aeddcb475e4b6a8648623dd2eec004-7"></a>{% endblock %}
</pre>
<p>And here is a diff for our <cite>app/templates/index.html</cite>:</p>
<pre class="code diff"><a name="rest_code_3c426416962143e0bcf72f40cbe86601-1"></a>               {{ form.hidden_tag() }}
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-2"></a>               {{ wtf.form_field(form.task) }}
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-3"></a>               &lt;div class="form-group"&gt;
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-4"></a><span class="gd">-                &lt;button type="submit" class="btn btn-default" id="submit"&gt;Run&lt;/button&gt;</span>
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-5"></a><span class="gi">+                &lt;button type="button" class="btn btn-default" id="submit"&gt;Run&lt;/button&gt;</span>
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-6"></a>               &lt;/div&gt;
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-7"></a>             &lt;/form&gt;
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-8"></a>           &lt;/div&gt;
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-9"></a>         &lt;/div&gt;
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-10"></a>       &lt;/div&gt;
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-11"></a> {% endblock %}
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-12"></a><span class="gi">+</span>
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-13"></a><span class="gi">+{% block app_scripts %}</span>
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-14"></a><span class="gi">+  &lt;script src="{{ url_for('static', filename='js/main.js') }}"&gt;&lt;/script&gt;</span>
<a name="rest_code_3c426416962143e0bcf72f40cbe86601-15"></a><span class="gi">+{% endblock %}</span>
</pre>
<p>We change the <cite>button</cite> type from <cite>submit</cite> to <cite>button</cite> so that it doesn't send a POST when clicked.
We send an Ajax query to <cite>$SCRIPT_ROOT/_run_task</cite> instead.</p>
<p>This is our new <cite>app/main/views.py</cite>:</p>
<pre class="code python"><a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-1"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-2"></a><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">tasks</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-3"></a><span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">TaskForm</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-4"></a>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-5"></a><span class="n">bp</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">'main'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-6"></a>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-7"></a>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-8"></a><span class="nd">@bp.route</span><span class="p">(</span><span class="s">'/_run_task'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-9"></a><span class="k">def</span> <span class="nf">run_task</span><span class="p">():</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-10"></a>    <span class="n">task</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'task'</span><span class="p">)</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-11"></a>    <span class="k">try</span><span class="p">:</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-12"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-13"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-14"></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'Task failed: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">500</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-15"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'result'</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-16"></a>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-17"></a>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-18"></a><span class="nd">@bp.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-19"></a><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-20"></a>    <span class="n">form</span> <span class="o">=</span> <span class="n">TaskForm</span><span class="p">()</span>
<a name="rest_code_c1ffc99470d54516a4cb836190bbd83c-21"></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre>
<p>Let's run this new example:</p>
<pre class="literal-block">
$ git checkout c1ccfe8b3a39079ab80f813b5733b324c8b65c6f
$ docker rm flaskrqexample_web
$ docker-compose up
</pre>
<p>This time we immediately get some feedback when clicking on <em>Run</em>. There is no reload.
That's better, but the server is still busy during the processing. If you try to open a new page, you won't get any answer until the task is done...</p>
<p>To avoid blocking the server, we'll use a task queue.</p>
</div>
<div class="section" id="third-version-setup-rq">
<h2>Third version: setup RQ</h2>
<p>As its name indicates, <a class="reference external" href="http://python-rq.org">RQ</a> (Redis Queue) is backed by <a class="reference external" href="http://redis.io">Redis</a>.
It is designed to have a low barrier entry.
What do we need to integrate <a class="reference external" href="http://python-rq.org">RQ</a> in our <a class="reference external" href="http://flask.pocoo.org">Flask</a> web app?</p>
<p>Let's first add some variables in <cite>app/settings.py</cite>:</p>
<pre class="code python"><a name="rest_code_9865db4d489f4a7ea111ec669602860e-1"></a><span class="c"># The Redis database to use</span>
<a name="rest_code_9865db4d489f4a7ea111ec669602860e-2"></a><span class="n">REDIS_URL</span> <span class="o">=</span> <span class="s">'redis://redis:6379/0'</span>
<a name="rest_code_9865db4d489f4a7ea111ec669602860e-3"></a><span class="c"># The queues to listen on</span>
<a name="rest_code_9865db4d489f4a7ea111ec669602860e-4"></a><span class="n">QUEUES</span> <span class="o">=</span> <span class="p">[</span><span class="s">'default'</span><span class="p">]</span>
</pre>
<p>To execute a background job, we need a worker.
<a class="reference external" href="http://python-rq.org">RQ</a> comes with the <cite>rq worker</cite> command to start a worker. To integrate it
better with our Flask app, we are going to write a simple <a class="reference external" href="https://flask-script.readthedocs.io/en/latest/">Flask-Script</a>
command. We add the following to our <cite>manage.py</cite>:</p>
<pre class="code python"><a name="rest_code_fbac572feb81420c91c76d17a8cb3196-1"></a><span class="kn">from</span> <span class="nn">rq</span> <span class="kn">import</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">Worker</span>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-2"></a>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-3"></a><span class="nd">@manager.command</span>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-4"></a><span class="k">def</span> <span class="nf">runworker</span><span class="p">():</span>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-5"></a>    <span class="n">redis_url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'REDIS_URL'</span><span class="p">]</span>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-6"></a>    <span class="n">redis_connection</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-7"></a>    <span class="k">with</span> <span class="n">Connection</span><span class="p">(</span><span class="n">redis_connection</span><span class="p">):</span>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-8"></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'QUEUES'</span><span class="p">])</span>
<a name="rest_code_fbac572feb81420c91c76d17a8cb3196-9"></a>        <span class="n">worker</span><span class="o">.</span><span class="n">work</span><span class="p">()</span>
</pre>
<p>The Manager runs the command inside a Flask test context, meaning we can
access the app config from within the worker.
This is nice because both our web application and
workers (and thus the jobs run on the worker) have access to the same
configuration variables. No separate config file. No discrepancy.
Everything is in <cite>app/settings.py</cite> and can be overwritten by <em>LOCAL_SETTINGS</em>.</p>
<p>To put a job in a Queue, you just create a <em>RQ Queue</em> and enqueue it.
One way to do that is to pass the connection when creating the <em>Queue</em>. This is a bit tedious.
<a class="reference external" href="http://python-rq.org">RQ</a> has the notion of <a class="reference external" href="http://python-rq.org/docs/connections/">connection context</a>. We take advantage of that
and register a function to push the connection and pop it before and after a request (<cite>app/main/views.py</cite>):</p>
<pre class="code python"><a name="rest_code_421630cff8134a96b6b6bb91762392f9-1"></a><span class="kn">import</span> <span class="nn">redis</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-2"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">g</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-3"></a><span class="kn">from</span> <span class="nn">rq</span> <span class="kn">import</span> <span class="n">push_connection</span><span class="p">,</span> <span class="n">pop_connection</span><span class="p">,</span> <span class="n">Queue</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-4"></a>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-5"></a>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-6"></a><span class="k">def</span> <span class="nf">get_redis_connection</span><span class="p">():</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-7"></a>    <span class="n">redis_connection</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">'_redis_connection'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-8"></a>    <span class="k">if</span> <span class="n">redis_connection</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-9"></a>        <span class="n">redis_url</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'REDIS_URL'</span><span class="p">]</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-10"></a>        <span class="n">redis_connection</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_redis_connection</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">redis_url</span><span class="p">)</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-11"></a>    <span class="k">return</span> <span class="n">redis_connection</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-12"></a>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-13"></a>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-14"></a><span class="nd">@bp.before_request</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-15"></a><span class="k">def</span> <span class="nf">push_rq_connection</span><span class="p">():</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-16"></a>    <span class="n">push_connection</span><span class="p">(</span><span class="n">get_redis_connection</span><span class="p">())</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-17"></a>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-18"></a>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-19"></a><span class="nd">@bp.teardown_request</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-20"></a><span class="k">def</span> <span class="nf">pop_rq_connection</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<a name="rest_code_421630cff8134a96b6b6bb91762392f9-21"></a>    <span class="n">pop_connection</span><span class="p">()</span>
</pre>
<p>This makes it easy to create a <em>Queue</em> in a request or application context.</p>
<p>The <cite>get_redis_connection</cite> function gets the Redis connection and stores it in the <em>flask.g</em> object.
This is the same as what is explained for SQLite <a class="reference external" href="http://flask.pocoo.org/docs/0.11/patterns/sqlite3/">here</a>.</p>
<p>With that in place, it's easy to enqueue a job. Here are the changes to the <em>run_task</em> function:</p>
<pre class="code diff"><a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-1"></a> @bp.route('/_run_task', methods=['POST'])
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-2"></a> def run_task():
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-3"></a>     task = request.form.get('task')
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-4"></a><span class="gd">-    try:</span>
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-5"></a><span class="gd">-        result = tasks.run(task)</span>
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-6"></a><span class="gd">-    except Exception as e:</span>
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-7"></a><span class="gd">-        return jsonify({'message': 'Task failed: {}'.format(e)}), 500</span>
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-8"></a><span class="gd">-    return jsonify({'result': result})</span>
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-9"></a><span class="gi">+    q = Queue()</span>
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-10"></a><span class="gi">+    job = q.enqueue(tasks.run, task)</span>
<a name="rest_code_f4c3d55b47f3448e996acf57be7eb3fe-11"></a><span class="gi">+    return jsonify({'job_id': job.get_id()})</span>
</pre>
<p>We enqeue our task and just return the job id for now.</p>
<p>Docker and <cite>docker-compose</cite> are now gonna come in handy to start eveything
(Redis, our web app and a worker). We just have to add the following to our
<cite>docker-compose.yml</cite> file:</p>
<pre class="code diff"><a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-1"></a> - "5000:5000"
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-2"></a> volumes:
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-3"></a> - .:/app
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-4"></a><span class="gi">+    depends_on:</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-5"></a><span class="gi">+    - redis</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-6"></a><span class="gi">+  worker:</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-7"></a><span class="gi">+    image: flaskrqexample</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-8"></a><span class="gi">+    container_name: flaskrqexample_worker</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-9"></a><span class="gi">+    environment:</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-10"></a><span class="gi">+      LOCAL_SETTINGS: /app/settings.cfg</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-11"></a><span class="gi">+    command: python manage.py runworker</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-12"></a><span class="gi">+    volumes:</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-13"></a><span class="gi">+    - .:/app</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-14"></a><span class="gi">+    depends_on:</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-15"></a><span class="gi">+    - redis</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-16"></a><span class="gi">+  redis:</span>
<a name="rest_code_4cb4fbd51594485fb8793287b1c1a09e-17"></a><span class="gi">+    image: redis:3.2</span>
</pre>
<p>Don't forget to add <em>redis</em> and <em>rq</em> to your <cite>environment.yml</cite> file!</p>
<pre class="code diff"><a name="rest_code_98587ef2bae149c2abb443d251a26903-1"></a>   - dominate==2.2.1
<a name="rest_code_98587ef2bae149c2abb443d251a26903-2"></a>   - flask-bootstrap==3.3.6.0
<a name="rest_code_98587ef2bae149c2abb443d251a26903-3"></a>   - flask-script==2.0.5
<a name="rest_code_98587ef2bae149c2abb443d251a26903-4"></a><span class="gi">+  - redis==2.10.5</span>
<a name="rest_code_98587ef2bae149c2abb443d251a26903-5"></a><span class="gi">+  - rq==0.6.0</span>
<a name="rest_code_98587ef2bae149c2abb443d251a26903-6"></a>   - visitor==0.1.3
</pre>
<p>Rebuild the docker image and start the app:</p>
<pre class="literal-block">
$ git checkout 437e710df3df0dd4b153f20027f5f00270b2e1a3
$ docker rm flaskrqexample_web
$ docker-compose build
$ docker-compose up
</pre>
<p>OK, nice, we started a job in the background! This is fine to run a task
and forget about it (like sending an e-mail). But how do we get the result back?</p>
</div>
<div class="section" id="fourth-version-poll-job-status-and-get-the-result">
<h2>Fourth version: poll job status and get the result</h2>
<p>This is the part I have been missing for some time. But, as often, it's not difficult when you have seen it.
When launching the job, we return an url to check the status of the job.
The trick is to periodically call back the same function until the job is finished or failed.</p>
<p>On the server side, the <cite>job_status</cite> endpoint uses the job_id to retrieve
the job and to get its status and result.</p>
<pre class="code python"><a name="rest_code_3ffa05066a23423193fc66827e1334df-1"></a><span class="nd">@bp.route</span><span class="p">(</span><span class="s">'/status/&lt;job_id&gt;'</span><span class="p">)</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-2"></a><span class="k">def</span> <span class="nf">job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">):</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-3"></a>    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-4"></a>    <span class="n">job</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">fetch_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-5"></a>    <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-6"></a>        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'status'</span><span class="p">:</span> <span class="s">'unknown'</span><span class="p">}</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-7"></a>    <span class="k">else</span><span class="p">:</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-8"></a>        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-9"></a>            <span class="s">'status'</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">get_status</span><span class="p">(),</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-10"></a>            <span class="s">'result'</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">,</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-11"></a>        <span class="p">}</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-12"></a>        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_failed</span><span class="p">:</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-13"></a>            <span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">exc_info</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-14"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-15"></a>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-16"></a>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-17"></a><span class="nd">@bp.route</span><span class="p">(</span><span class="s">'/_run_task'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-18"></a><span class="k">def</span> <span class="nf">run_task</span><span class="p">():</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-19"></a>    <span class="n">task</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'task'</span><span class="p">)</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-20"></a>    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-21"></a>    <span class="n">job</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
<a name="rest_code_3ffa05066a23423193fc66827e1334df-22"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({}),</span> <span class="mi">202</span><span class="p">,</span> <span class="p">{</span><span class="s">'Location'</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s">'main.job_status'</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">get_id</span><span class="p">())}</span>
</pre>
<p>The <cite>run_task</cite> function returns an empty response with the <a class="reference external" href="https://httpstatuses.com/202">202</a> status
code. We use the <em>Location</em> response-header field to pass the <cite>job_status</cite> URL to the
client.</p>
<p>On the client side, we retrieve the URL from the header and call the new
<cite>check_job_status</cite> function.</p>
<pre class="code diff"><a name="rest_code_41e5ebfa9b9640248584c110e124241c-1"></a><span class="gu">@@ -28,8 +53,11 @@ $(document).ready(function() {</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-2"></a>       data: $("#taskForm").serialize(),
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-3"></a>       method: "POST",
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-4"></a>       dataType: "json",
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-5"></a><span class="gd">-      success: function(data) {</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-6"></a><span class="gd">-        flash_alert("Job " + data.job_id + " started...", "info", false);</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-7"></a><span class="gi">+      success: function(data, status, request) {</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-8"></a><span class="gi">+        $("#submit").attr("disabled", "disabled");</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-9"></a><span class="gi">+        flash_alert("Running " + task + "...", "info");</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-10"></a><span class="gi">+        var status_url = request.getResponseHeader('Location');</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-11"></a><span class="gi">+        check_job_status(status_url);</span>
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-12"></a>       },
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-13"></a>       error: function(jqXHR, textStatus, errorThrown) {
<a name="rest_code_41e5ebfa9b9640248584c110e124241c-14"></a>         flash_alert("Failed to start " + task, "danger");
</pre>
<p>We use <cite>setTimeout</cite> to call back the same function until the job is done (finished
or failed).</p>
<pre class="code javascript"><a name="rest_code_c7b395efc6774b26972f681db9bd3ece-1"></a><span class="kd">function</span> <span class="nx">check_job_status</span><span class="p">(</span><span class="nx">status_url</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-2"></a>  <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="nx">status_url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-3"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-4"></a>    <span class="k">switch</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-5"></a>      <span class="k">case</span> <span class="s2">"unknown"</span><span class="o">:</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-6"></a>          <span class="nx">flash_alert</span><span class="p">(</span><span class="s2">"Unknown job id"</span><span class="p">,</span> <span class="s2">"danger"</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-7"></a>          <span class="nx">$</span><span class="p">(</span><span class="s2">"#submit"</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s2">"disabled"</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-8"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-9"></a>      <span class="k">case</span> <span class="s2">"finished"</span><span class="o">:</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-10"></a>          <span class="nx">flash_alert</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="s2">"success"</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-11"></a>          <span class="nx">$</span><span class="p">(</span><span class="s2">"#submit"</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s2">"disabled"</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-12"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-13"></a>      <span class="k">case</span> <span class="s2">"failed"</span><span class="o">:</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-14"></a>          <span class="nx">flash_alert</span><span class="p">(</span><span class="s2">"Job failed: "</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s2">"danger"</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-15"></a>          <span class="nx">$</span><span class="p">(</span><span class="s2">"#submit"</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s2">"disabled"</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-16"></a>          <span class="k">break</span><span class="p">;</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-17"></a>      <span class="k">default</span><span class="o">:</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-18"></a>        <span class="c1">// queued/started/deferred</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-19"></a>        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-20"></a>          <span class="nx">check_job_status</span><span class="p">(</span><span class="nx">status_url</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-21"></a>        <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-22"></a>    <span class="p">}</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-23"></a>  <span class="p">});</span>
<a name="rest_code_c7b395efc6774b26972f681db9bd3ece-24"></a><span class="p">}</span>
</pre>
<p>Let's checkout this commit and run our app again:</p>
<pre class="literal-block">
$ git checkout da8360aefb222afc17417a518ac25029566071d6
$ docker rm flaskrqexample_web
$ docker rm flaskrqexample_worker
$ docker-compose up
</pre>
<p>Try submitting some tasks. This time you can open another window and the
server will answer even when a task is running :-)
You can open a console in your browser to see the polling and the response
from the <cite>job_status</cite> function.
Note that we only have one worker, so if you start a second task, it will be enqueued
and run only when the first one is done.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Using <a class="reference external" href="http://python-rq.org">RQ</a> with <a class="reference external" href="http://flask.pocoo.org">Flask</a> isn't that difficult. So no need to block the server to
get the result of a long task.
There are a few more things to say, but this post starts to be a bit long,
so I'll keep that for another time.</p>
<p>Thanks again to <a class="reference external" href="http://blog.miguelgrinberg.com/">Miguel Grinberg</a>
and all his posts about Flask!</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/installing-openvpn-on-a-raspberry-pi-with-ansible/" class="u-url">Installing OpenVPN on a Raspberry Pi with Ansible</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/installing-openvpn-on-a-raspberry-pi-with-ansible/" rel="bookmark"><time class="published dt-published" datetime="2016-07-18T22:26:28+02:00" title="2016-07-18 22:26">2016-07-18 22:26</time></a></p>
                <p class="commentline">
        
    <a href="posts/installing-openvpn-on-a-raspberry-pi-with-ansible/#disqus_thread" data-disqus-identifier="cache/posts/installing-openvpn-on-a-raspberry-pi-with-ansible.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I have to confess that I initially decided to install a VPN,
not to secure my connection when using a free Wireless Acces Point in an
airport or hotel, but to watch Netflix :-)</p>
<p>I had a VPS in France where I installed sniproxy to access Netflix.
Not that I find the french catalogue so great, but as a French guy living
in Sweden, it was a good way for my kids to watch some french programs.
But Netflix started to block VPS providers...</p>
<p>I have a brother in France who has a Fiber Optic Internet access.
That was a good opportunity to setup a private VPN and I bought him a Raspberry Pi.</p>
<p>There are many resources on the web about <a class="reference external" href="https://openvpn.net/index.php/open-source/documentation/howto.html">OpenVPN</a>.
A paper worth mentioning is: <a class="reference external" href="https://www.sans.org/reading-room/whitepapers/networkdevs/soho-remote-access-vpn-easy-pie-raspberry-pi-34427">SOHO Remote Access VPN. Easy as Pie, Raspberry Pi...</a>
It's from end of 2013 and describes Esay-RSA 2.0 (that used to be installed with
OpenVPN), but it's still an interesting read.</p>
<p>Anyway, most resources describe all the commands to run.
I don't really like installing softwares by running a bunch of commands. Propably due
to my professional experience, I like things to be reproducible.
That's why I love to automate things. I wrote a lot of shell scripts over
the years. About two years ago, I discovered <a class="reference external" href="http://docs.ansible.com/ansible/index.html">Ansible</a> and it quickly became my
favorite tool to deploy software.</p>
<p>So let's write a small Ansible playbook to install OpenVPN on a Raspberry Pi.</p>
<p>First the firewall configuration. I like to use <a class="reference external" href="https://help.ubuntu.com/community/UFW">ufw</a> which is quite easy to
setup:</p>
<pre class="literal-block">
- name: install dependencies
  apt: name=ufw state=present update_cache=yes cache_valid_time=3600

- name: update ufw default forward policy
  lineinfile: dest=/etc/default/ufw regexp=^DEFAULT_FORWARD_POLICY line=DEFAULT_FORWARD_POLICY="ACCEPT"
  notify: reload ufw

- name: enable ufw ip forward
  lineinfile: dest=/etc/ufw/sysctl.conf regexp=^net/ipv4/ip_forward line=net/ipv4/ip_forward=1
  notify: reload ufw

- name: add NAT rules to ufw
  blockinfile:
    dest: /etc/ufw/before.rules
    insertbefore: BOF
    block: |
      # Nat table
      *nat
      :POSTROUTING ACCEPT [0:0]

      # Nat rules
      -F
      -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j SNAT --to-source {{ansible_eth0.ipv4.address}}

      # don't delete the 'COMMIT' line or these nat rules won't be processed
      COMMIT
  notify: reload ufw

- name: allow ssh
  ufw: rule=limit port=ssh proto=tcp

- name: allow openvpn
  ufw: rule=allow port={{openvpn_port}} proto={{openvpn_protocol}}

- name: enable ufw
  ufw: logging=on state=enabled
</pre>
<p>This enables IP forwarding, adds the required NAT rules and allows ssh and
openvpn.</p>
<p>The rest of the playbook installs OpenVPN and generates all the keys automatically,
except the Diffie-Hellman one that should be generated locally.
This is just because it takes for ever on the Pi :-)</p>
<pre class="literal-block">
- name: install openvpn
  apt: name=openvpn state=present

- name: create /etc/openvpn
  file: path=/etc/openvpn state=directory mode=0755 owner=root group=root

- name: create /etc/openvpn/keys
  file: path=/etc/openvpn/keys state=directory mode=0700 owner=root group=root

- name: create clientside and serverside directories
  file: path="{{item}}" state=directory mode=0755
  with_items:
      - "{{clientside}}/keys"
      - "{{serverside}}"
  become: true
  become_user: "{{user}}"

- name: create openvpn base client.conf
  template: src=client.conf.j2 dest={{clientside}}/client.conf owner=root group=root mode=0644

- name: download EasyRSA
  get_url: url={{easyrsa_url}} dest=/home/{{user}}/openvpn
  become: true
  become_user: "{{user}}"

- name: create scripts
  template: src={{item}}.j2 dest=/home/{{user}}/openvpn/{{item}} owner=root group=root mode=0755
  with_items:
    - create_serverside
    - create_clientside
  tags: client

- name: run serverside script
  command: ./create_serverside
  args:
    chdir: /home/{{user}}/openvpn
    creates: "{{easyrsa_server}}/ta.key"
  become: true
  become_user: "{{user}}"

- name: run clientside script
  command: ./create_clientside {{item}}
  args:
    chdir: /home/{{user}}/openvpn
    creates: "{{clientside}}/files/{{item}}.ovpn"
  become: true
  become_user: "{{user}}"
  with_items: "{{openvpn_clients}}"
  tags: client

- name: install all server keys
  command: install -o root -g root -m 600 {{item.name}} /etc/openvpn/keys/
  args:
    chdir: "{{item.path}}"
    creates: /etc/openvpn/keys/{{item.name}}
  with_items:
    - { name: 'ca.crt', path: "{{easyrsa_server}}/pki" }
    - { name: '{{ansible_hostname}}.crt', path: "{{easyrsa_server}}/pki/issued" }
    - { name: '{{ansible_hostname}}.key', path: "{{easyrsa_server}}/pki/private" }
    - { name: 'ta.key', path: "{{easyrsa_server}}" }

- name: copy Diffie-Hellman key
  copy: src="{{openvpn_dh}}" dest=/etc/openvpn/keys/dh.pem owner=root group=root mode=0600

- name: create openvpn server.conf
  template: src=server.conf.j2 dest=/etc/openvpn/server.conf owner=root group=root mode=0644
  notify: restart openvpn

- name: start openvpn
  service: name=openvpn state=started
</pre>
<p>The <em>create_clientside</em> script generates all the required client keys and creates an ovpn file
that includes them.  It makes it very easy to install on any device: just one file to
drop.</p>
<p>One thing I stumbled upon is the <em>ns-cert-type server</em> option that I
initially used in the server configuration. This prevented the client to
connect. As explained <a class="reference external" href="https://community.openvpn.net/openvpn/wiki/EasyRSA3-OpenVPN-Howto">here</a>,
this option is a deprecated "Netscape" cert attribute. It's not enabled by
default with Easy-RSA 3.</p>
<p>Fortunately, the mentioned <a class="reference external" href="https://community.openvpn.net/openvpn/wiki/EasyRSA3-OpenVPN-Howto">howto</a> and
the <a class="reference external" href="https://github.com/OpenVPN/easy-rsa">Easy-RSA github</a> page are good references
for Easy-RSA 3.</p>
<p>One important thing to note is that I create all the keys with no password.
That's obviously not the most secure and recommended way.
Anyone accessing the CA could sign new requests. But it can be stored offline on an USB stick.
I actually think that for my use case it's not even worth keeping the CA.
Sure it means I can't easily add a new client or revoke a certificate.
But with the playbook, it's super easy to throw all the keys and regenerate everything.
That forces to replace all clients configuration but with 2 or 3
clients, this is not a problem.</p>
<p>For sure don't leave all the generated keys on the Pi!
After copying the clients ovpn files, remove the /home/pi/openvpn
directory (save it somewhere safe if you want to add new clients or revoke
a certificate without regenerating everything).</p>
<p>The full playbook can be found on <a class="reference external" href="https://github.com/beenje/pi_openvpn">github</a>.
The README includes some quick instructions.</p>
<p>I now have a private VPN in France and one at home that I can use to
securely access my NAS from anywhere!</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/uwsgi-send_file-and-python35/" class="u-url">uWSGI, send_file and Python 3.5</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Benjamin Bertrand
            </span></p>
            <p class="dateline"><a href="posts/uwsgi-send_file-and-python35/" rel="bookmark"><time class="published dt-published" datetime="2016-07-05T20:39:29+02:00" title="2016-07-05 20:39">2016-07-05 20:39</time></a></p>
                <p class="commentline">
        
    <a href="posts/uwsgi-send_file-and-python35/#disqus_thread" data-disqus-identifier="cache/posts/uwsgi-send_file-and-python35.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I have a Flask app that returns an in-memory bytes buffer (<a class="reference external" href="https://docs.python.org/3/library/io.html#io.BytesIO">io.Bytesio</a>) using Flask <a class="reference external" href="http://flask.pocoo.org/docs/0.11/api/#flask.send_file">send_file</a> function.</p>
<p>The app is deployed using <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a> behind Nginx.
This was working fine with Python 3.4.</p>
<p>When I updated Python to 3.5, I got the following exception when trying to download a file:</p>
<pre class="literal-block">
io.UnsupportedOperation: fileno

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1817, in wsgi_app
    response = self.full_dispatch_request()
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1477, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1381, in handle_user_exception
    reraise(exc_type, exc_value, tb)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/_compat.py", line 33, in reraise
    raise value
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1475, in full_dispatch_request
    rv = self.dispatch_request()
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/app.py", line 1461, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask_login.py", line 758, in decorated_view
    return func(*args, **kwargs)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask_security/decorators.py", line 194, in decorated_view
    return fn(*args, **kwargs)
  File "/webapps/bowser/bowser/app/bext/views.py", line 116, in download
    as_attachment=True)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/flask/helpers.py", line 523, in send_file
    data = wrap_file(request.environ, file)
  File "/webapps/bowser/miniconda3/envs/bowser/lib/python3.5/site-packages/werkzeug/wsgi.py", line 726, in wrap_file
    return environ.get('wsgi.file_wrapper', FileWrapper)(file, buffer_size)
SystemError: &lt;built-in function uwsgi_sendfile&gt; returned a result with an error set
</pre>
<p>I quickly found the following <a class="reference external" href="http://lists.unbit.it/pipermail/uwsgi/2015-September/008186.html">post</a> with the same exception, but no answer...
A little more googling brought me to this github issue: <a class="reference external" href="https://github.com/unbit/uwsgi/issues/1126">In python3, uwsgi fails to respond a
stream from BytesIO object</a></p>
<p>As described, you should run uwsgi with the <cite>--wsgi-disable-file-wrapper</cite> flag to avoid this problem.
As with all command line options, you can add the following entry in your
uwsgi.ini file:</p>
<pre class="literal-block">
wsgi-disable-file-wrapper = true
</pre>
<p>Note that <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a> 2.0.12 is required.</p>
<p>When searching in <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a> documentation, I only found one match in <a class="reference external" href="http://uwsgi-docs.readthedocs.io/en/latest/Changelog-2.0.12.html?highlight=wsgi-disable-file-wrapper">uWSGI 2.0.12 release notes</a>.</p>
<p>A problem/option that should be better documented. Probably a pull request to open :-)</p>
<p>UPDATE (2016-07-13): pull request <a class="reference external" href="https://github.com/unbit/uwsgi-docs/pull/317">merged</a></p>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-1.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="tchutchut";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script><script type="text/x-mathjax-config">
            MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
            </script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:beenje@gmail.com">Benjamin Bertrand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99836987-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
