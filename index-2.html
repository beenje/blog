<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Notes to myself">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tchut-Tchut Blog (old posts, page 2) | Tchut-Tchut Blog</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://beenje.github.io/blog/index-2.html">
<link rel="prev" href="." type="text/html">
<link rel="next" href="index-1.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="http://beenje.github.io/blog/">

            <span id="blog-title">Tchut-Tchut Blog</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>
                </li>
<li class="nav-item">
<a href="stories/about/index.html" class="nav-link">About</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/dockerfile-anti-patterns-and-best-practices/" class="u-url">Dockerfile anti-patterns and best practices</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Benjamin Bertrand
            </span></p>
            <p class="dateline">
            <a href="posts/dockerfile-anti-patterns-and-best-practices/" rel="bookmark">
            <time class="published dt-published" datetime="2017-03-16T22:10:49+01:00" itemprop="datePublished" title="2017-03-16 22:10">2017-03-16 22:10</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/dockerfile-anti-patterns-and-best-practices/#disqus_thread" data-disqus-identifier="cache/posts/dockerfile-anti-patterns-and-best-practices.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I've been using <a class="reference external" href="https://www.docker.com">Docker</a> for some time now.
There is already a lot of documentation available online but I recently
saw the same "anti-patterns" several times, so I thought it was worth writing a post about
it.</p>
<p>I won't repeat all the <a class="reference external" href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Best practices for writing Dockerfiles</a> here.
You should definitively read that page.</p>
<p>I want to emphasize some things that took me some time to understand.</p>
<div class="section" id="avoid-invalidating-the-cache">
<h2>Avoid invalidating the cache</h2>
<p>Let's take a simple example with a Python application:</p>
<pre class="literal-block">FROM python:3.6

COPY . /app
WORKDIR /app

RUN pip install -r requirements.txt

ENTRYPOINT ["python"]
CMD ["ap.py"]</pre>
<p>It's actually an example I have seen several times online.
This looks fine, right?</p>
<p>The problem is that the <em>COPY . /app</em> command will invalidate the cache as
soon as any file in the current directory is updated.
Let's say you just change the <em>README</em> file and run <em>docker build</em> again.
Docker will have to re-install all the requirements because the
<em>RUN pip</em> command is run after the <em>COPY</em> that invalidated the cache.</p>
<p>The requirements should only be re-installed if the <em>requirements.txt</em>
file changes:</p>
<pre class="literal-block">FROM python:3.6

WORKDIR /app

COPY requirements.txt /app/requirements.txt
RUN pip install -r requirements.txt

COPY . /app

ENTRYPOINT ["python"]
CMD ["ap.py"]</pre>
<p>With this Dockerfile, the <em>RUN pip</em> command will only be re-run when the
<em>requirements.txt</em> file changes. It will use the cache otherwise.</p>
<p>This is much more efficient and will save you quite some time if you have
many requirements to install.</p>
</div>
<div class="section" id="minimize-the-number-of-layers">
<h2>Minimize the number of layers</h2>
<p>What does that really mean?</p>
<p>Each <a class="reference external" href="https://www.docker.com">Docker</a> image references a list of read-only layers that represent
filesystem differences. Every command in your Dockerfile will create a new
layer.</p>
<p>Let's use the following Dockerfile:</p>
<pre class="literal-block">FROM centos:7

RUN yum update -y
RUN yum install -y sudo
RUN yum install -y git
RUN yum clean all</pre>
<p>Build the docker image and check the layers created with the <em>docker history</em> command:</p>
<pre class="literal-block">$ docker build -t centos-test .
...
$ docker images
REPOSITORY                       TAG                 IMAGE ID            CREATED              SIZE
centos-test                      latest              1fae366a2613        About a minute ago   470 MB
centos                           7                   98d35105a391        24 hours ago         193 MB
$ docker history centos-test
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
1fae366a2613        2 minutes ago       /bin/sh -c yum clean all                        1.67 MB
999e7c7c0e14        2 minutes ago       /bin/sh -c yum install -y git                   133 MB
c97b66528792        3 minutes ago       /bin/sh -c yum install -y sudo                  81 MB
e0c7b450b7a8        3 minutes ago       /bin/sh -c yum update -y                        62.5 MB
98d35105a391        24 hours ago        /bin/sh -c #(nop)  CMD ["/bin/bash"]            0 B
&lt;missing&gt;           24 hours ago        /bin/sh -c #(nop)  LABEL name=CentOS Base ...   0 B
&lt;missing&gt;           24 hours ago        /bin/sh -c #(nop) ADD file:29f66b8b4bafd0f...   193 MB
&lt;missing&gt;           6 months ago        /bin/sh -c #(nop)  MAINTAINER https://gith...   0 B</pre>
<p>There are two problems with this Dockerfile:</p>
<ol class="arabic simple">
<li><p>We added too many layers for nothing.</p></li>
<li><p>The <em>yum clean all</em> command is meant to reduce the size of the image but it
actually does the opposite by adding a new layer!</p></li>
</ol>
<p>Let's check that by removing the latest command and running the build
again:</p>
<pre class="literal-block">FROM centos:7

RUN yum update -y
RUN yum install -y sudo
RUN yum install -y git
# RUN yum clean all</pre>
<pre class="literal-block">$ docker build -t centos-test .
...
$ docker images
REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE
centos-test                      latest              999e7c7c0e14        11 minutes ago      469 MB
centos                           7                   98d35105a391        24 hours ago        193 MB</pre>
<p>The new image without the <em>yum clean all</em> command is indeed smaller than the previous image (1.67 MB smaller)!</p>
<p>If you want to remove files, it's important to do that in the same RUN command that created those files.
Otherwise there is no point.</p>
<p>Here is the proper way to do it:</p>
<pre class="literal-block">FROM centos:7

RUN yum update -y \
  &amp;&amp; yum install -y \
  sudo \
  git \
  &amp;&amp; yum clean all</pre>
<p>Let's build this new image:</p>
<pre class="literal-block">$ docker build -t centos-test .
...
$ docker images
REPOSITORY                       TAG                 IMAGE ID            CREATED             SIZE
centos-test                      latest              54a328ef7efd        21 seconds ago      265 MB
centos                           7                   98d35105a391        24 hours ago        193 MB
$ docker history centos-test
IMAGE               CREATED              CREATED BY                                      SIZE                COMMENT
54a328ef7efd        About a minute ago   /bin/sh -c yum update -y   &amp;&amp; yum install ...   72.8 MB
98d35105a391        24 hours ago         /bin/sh -c #(nop)  CMD ["/bin/bash"]            0 B
&lt;missing&gt;           24 hours ago         /bin/sh -c #(nop)  LABEL name=CentOS Base ...   0 B
&lt;missing&gt;           24 hours ago         /bin/sh -c #(nop) ADD file:29f66b8b4bafd0f...   193 MB
&lt;missing&gt;           6 months ago         /bin/sh -c #(nop)  MAINTAINER https://gith...   0 B</pre>
<p>The new image is only 265 MB compared to the 470 MB of the original image.
There isn't much more to say :-)</p>
<p>If you want to know more about images and layers, you should read the
documentation: <a class="reference external" href="https://docs.docker.com/engine/userguide/storagedriver/imagesandcontainers/">Understand images, containers, and storage drivers</a>.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Avoid invalidating the cache:</p>
<ul class="simple">
<li><p>start your Dockerfile with commands that should not change often</p></li>
<li><p>put commands that can often invalidate the cache (like COPY .) as
late as possible</p></li>
<li><p>only add the needed files (use a .dockerignore file)</p></li>
</ul>
<p>Minimize the number of layers:</p>
<ul class="simple">
<li><p>put related commands in the same RUN instruction</p></li>
<li><p>remove files in the same RUN command that created them</p></li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/control-your-accessories-from-home-assistant-with-siri-and-homekit/" class="u-url">Control your accessories from Home Assistant with Siri and HomeKit</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Benjamin Bertrand
            </span></p>
            <p class="dateline">
            <a href="posts/control-your-accessories-from-home-assistant-with-siri-and-homekit/" rel="bookmark">
            <time class="published dt-published" datetime="2017-02-16T22:58:56+01:00" itemprop="datePublished" title="2017-02-16 22:58">2017-02-16 22:58</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/control-your-accessories-from-home-assistant-with-siri-and-homekit/#disqus_thread" data-disqus-identifier="cache/posts/control-your-accessories-from-home-assistant-with-siri-and-homekit.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>While reading more about <a class="reference external" href="https://home-assistant.io">Home Assistant</a>, I
discovered it was possible to control your accessories from Home Assistant
with Siri and HomeKit. I decided to give that a try.</p>
<p>This requires to install <a class="reference external" href="https://github.com/nfarina/homebridge">Homebridge</a> and
the <a class="reference external" href="https://github.com/home-assistant/homebridge-homeassistant">homebridge-homeassitant plugin</a>.</p>
<div class="section" id="install-homebridge">
<h2>Install Homebridge</h2>
<p>Homebridge is a lightweight NodeJS server that emulates the iOS HomeKit
API. Let's install it in the same <a class="reference external" href="posts/home-assistant-on-turris-omnia-via-lxc-container">LXC container as Home Assistant</a>:</p>
<pre class="literal-block">root@turris:~# lxc-attach -n homeassistant</pre>
<p>I followed the <a class="reference external" href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi">Running HomeBridge on a Raspberry Pi page</a>.</p>
<p>We need curl and git:</p>
<pre class="literal-block">root@homeassistant:~# apt-get install -y curl git</pre>
<p>Install Node:</p>
<pre class="literal-block">root@homeassistant:~# curl -sL https://deb.nodesource.com/setup_6.x | bash -
## Installing the NodeSource Node.js v6.x repo...

## Populating apt-get cache...

root@homeassistant:~# apt-get install -y nodejs</pre>
<p>Install avahi and other dependencies:</p>
<pre class="literal-block">root@homeassistant:~# apt-get install -y libavahi-compat-libdnssd-dev</pre>
<p>Install Homebridge and dependencies still following this <a class="reference external" href="https://github.com/nfarina/homebridge/wiki/Running-HomeBridge-on-a-Raspberry-Pi#install-homebridge-and-dependencies">page</a>.
Note that I had a strange problem here. The <em>npm</em> command didn't produce
any output. I found the same issue on <a class="reference external" href="http://stackoverflow.com/questions/40755598/containers-lxc-attach-and-npm-no-output">stackoverflow</a>
and even an <a class="reference external" href="https://github.com/npm/npm/issues/15681">issue on github</a>.
The workaround is just to open a new terminal...</p>
<pre class="literal-block">root@homeassistant:~# npm install -g --unsafe-perm homebridge hap-nodejs node-gyp
root@homeassistant:~# cd /usr/lib/node_modules/homebridge/
root@homeassistant:/usr/lib/node_modules/homebridge# npm install --unsafe-perm bignum
root@homeassistant:/usr/lib/node_modules/homebridge# cd ../hap-nodejs/node_modules/mdns/
root@homeassistant:/usr/lib/node_modules/hap-nodejs/node_modules/mdns# node-gyp BUILDTYPE=Release rebuild</pre>
</div>
<div class="section" id="install-and-configure-homebridge-homeassistant-plugin">
<h2>Install and configure homebridge-homeassistant plugin</h2>
<pre class="literal-block">root@homeassistant:/usr/lib/node_modules/hap-nodejs/node_modules/mdns# cd
root@homeassistant:~# npm install -g --unsafe-perm homebridge-homeassistant</pre>
<p>Try to start Homebridge:</p>
<pre class="literal-block">root@homeassistant:~# su -s /bin/bash homeassistant
homeassistant@homeassistant:~$ homebridge</pre>
<p>Homebridge won't do anything until you've created a configuration file.
So press CTRL-C and create the file <cite>~/.homebridge/config.json</cite>:</p>
<pre class="literal-block">homeassistant@homeassistant:~$ cat &lt;&lt;EOF &gt;&gt; ~/.homebridge/config.json
{
  "bridge": {
    "name": "Homebridge",
    "username": "CC:22:3D:E3:CE:30",
    "port": 51826,
    "pin": "031-45-154"
  },

  "platforms": [
    {
      "platform": "HomeAssistant",
      "name": "HomeAssistant",
      "host": "http://localhost:8123",
      "logging": false
    }
 ]
}
EOF</pre>
<p>Note that you can change the username and pin code.
You will need the PIN code to add the Homebridge accessory to HomeKit.</p>
<p>Check the <a class="reference external" href="https://github.com/home-assistant/homebridge-homeassistant#configuration">Home Assistant plugin page</a>
for more information on how to configure the plugin.</p>
</div>
<div class="section" id="automatically-start-homebridge">
<h2>Automatically start Homebridge</h2>
<p>Let's configure systemd.
Create the file <cite>/etc/systemd/system/home-assistant@homebridge.service</cite>:</p>
<pre class="literal-block">root@homeassistant:~# cat &lt;&lt;EOF &gt;&gt; /etc/systemd/system/home-assistant@homebridge.service
[Unit]
Description=Node.js HomeKit Server
After=syslog.target network-online.target

[Service]
Type=simple
User=homeassistant
ExecStart=/usr/bin/homebridge -U /home/homeassistant/.homebridge
Restart=on-failure
RestartSec=10
KillMode=process

[Install]
WantedBy=multi-user.target
EOF</pre>
<p>Enable and launch Homebridge:</p>
<pre class="literal-block">root@homeassistant:~# systemctl --system daemon-reload
root@homeassistant:~# systemctl enable home-assistant@homebridge
Created symlink from /etc/systemd/system/multi-user.target.wants/home-assistant@homebridge.service to /etc/systemd/system/home-assistant@homebridge.service.
root@homeassistant:~# systemctl start home-assistant@homebridge</pre>
</div>
<div class="section" id="adding-homebridge-to-ios">
<h2>Adding Homebridge to iOS</h2>
<p>Homebridge and the Home Assistant plugin are now running.
Using the Home app on your iOS device, you should be able to add the accessory "Homebridge".
See <a class="reference external" href="https://github.com/nfarina/homebridge#adding-homebridge-to-ios">Homebridge README</a> for
more information. You will need to enter the <em>PIN code</em> defined in your
<cite>config.json</cite> file.</p>
<p>You should then see the Homebridge bridge on your device:</p>
<img alt="/images/homebridge.png" src="images/homebridge.png"><p>And it will automatically add all the accessories defined in Home Assistant!</p>
<img alt="/images/home_accessories.png" src="images/home_accessories.png"><p>You can now even use Siri to control your devices, like turning ON or OFF the TV VPN.</p>
<img alt="/images/siri_tv_vpn_off.png" src="images/siri_tv_vpn_off.png"><p>Note that I renamed the original switch to make it easier to pronounce.
As described in the <a class="reference external" href="https://github.com/nfarina/homebridge#interacting-with-your-devices">README</a>,
avoid names usually used by Siri like "Radio" or "Sonos".</p>
<p>That's it! Homebridge is really a nice addition to Home Assistant if you have some iOS devices at home.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/docker-and-conda/" class="u-url">Docker and conda</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Benjamin Bertrand
            </span></p>
            <p class="dateline">
            <a href="posts/docker-and-conda/" rel="bookmark">
            <time class="published dt-published" datetime="2017-01-28T23:32:56+01:00" itemprop="datePublished" title="2017-01-28 23:32">2017-01-28 23:32</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/docker-and-conda/#disqus_thread" data-disqus-identifier="cache/posts/docker-and-conda.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>I just read a blog post about <a class="reference external" href="http://fmgdata.kinja.com/using-docker-with-conda-environments-1790901398">Using Docker with Conda Environments</a>.
I do things slightly differently so I thought I would share an example of
Dockerfile I use:</p>
<pre class="literal-block">FROM continuumio/miniconda3:latest

# Install extra packages if required
RUN apt-get update &amp;&amp; apt-get install -y \
    xxxxxx \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# Add the user that will run the app (no need to run as root)
RUN groupadd -r myuser &amp;&amp; useradd -r -g myuser myuser

WORKDIR /app

# Install myapp requirements
COPY environment.yml /app/environment.yml
RUN conda config --add channels conda-forge \
    &amp;&amp; conda env create -n myapp -f environment.yml \
    &amp;&amp; rm -rf /opt/conda/pkgs/*

# Install myapp
COPY . /app/
RUN chown -R myuser:myuser /app/*

# activate the myapp environment
ENV PATH /opt/conda/envs/myapp/bin:$PATH</pre>
<p>I don't run <cite>source activate myapp</cite> but just use <cite>ENV</cite> to update the <cite>PATH</cite>
variable. There is only one environment in the docker image. No need for the extra
checks done by the activate script.</p>
<p>With this Dockerfile, any command will be run in the <cite>myapp</cite>
environment.</p>
<p>Just a few additional notes:</p>
<ol class="arabic simple">
<li><p>Be sure to only copy the file <cite>environment.yml</cite> before to copy the full
current directory. Otherwise any change in the directory would
invalidate the docker cache.
We only want to re-create the conda environment if <cite>environment.yml</cite>
changes.</p></li>
<li><p>I always add the <a class="reference external" href="https://conda-forge.github.io">conda-forge channel</a>.
Check this <a class="reference external" href="https://www.continuum.io/blog/developer-blog/community-conda-forge">post</a>
if you haven't heard of it yet.</p></li>
<li><p>I clean some cache (<em>/var/lib/apt/lists/</em> and <em>/opt/conda/pkgs/</em>) to
make the image a bit smaller.</p></li>
</ol>
<p>I switched from virtualenv to <a class="reference external" href="https://conda.io">conda</a> a while ago and I really enjoy it.
A big thanks to <a class="reference external" href="https://www.continuum.io">Continuum Analytics</a>!</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/home-assistant-on-turris-omnia-via-lxc-container/" class="u-url">Home Assistant on Turris Omnia via LXC container</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Benjamin Bertrand
            </span></p>
            <p class="dateline">
            <a href="posts/home-assistant-on-turris-omnia-via-lxc-container/" rel="bookmark">
            <time class="published dt-published" datetime="2017-01-26T22:01:30+01:00" itemprop="datePublished" title="2017-01-26 22:01">2017-01-26 22:01</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/home-assistant-on-turris-omnia-via-lxc-container/#disqus_thread" data-disqus-identifier="cache/posts/home-assistant-on-turris-omnia-via-lxc-container.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>In a previous post, I described <a class="reference external" href="posts/openvpn-source-based-routing">how to install OpenVPN client on a Turris
Omnia router</a>. To start or stop the
client, I was using the command line and mentioned the LuCi Web User
Interface.</p>
<p>Both ways are not super easy and fast to access.
A while ago, I wrote a small <a class="reference external" href="http://flask.pocoo.org">Flask</a> web
application to change some settings in my router. The application just
allowed to click on a button to run a script via ssh on the router.</p>
<p>So I could write a small webapp to do just that.
But I recently read about <a class="reference external" href="https://home-assistant.io">Home Assistant</a>. It's
an open-source home automation platform to track and control your devices
at home. There are many components available, including <a class="reference external" href="https://home-assistant.io/components/switch.command_line/">Command Line
Switch</a> which
looks exactly like what I need.</p>
<p>The Raspberry Pi is a popular device to install Home Assistant.
But my <a class="reference external" href="https://omnia.turris.cz/en/">Turris Omnia</a> is quite powerful for a router with
1 GB of RAM and 8 GB of flash. It's time to use some of that power.</p>
<p>From what I <a class="reference external" href="https://forum.turris.cz/t/home-automation-home-assistant-upgrade/1037">read</a>,
there is an openWrt package of Home Assistant.
I couldn't find it in the Turris Omnia available packages.
Anyway, there is another feature I wanted to try: <a class="reference external" href="https://www.turris.cz/doc/en/howto/lxc">LXC Containers</a>. Home Assistant is a Python
application, so it's easy to install in a linux container and would allow
to easily keep the version up-to-date.</p>
<p>So let's start!</p>
<div class="section" id="create-a-lxc-container">
<h2>Create a LXC container</h2>
<p>As described <a class="reference external" href="https://www.turris.cz/doc/en/howto/lxc">here</a>, you can
create a LXC container via the LuCI web interface or via the command
line:</p>
<pre class="literal-block">root@turris:~# lxc-create -t download -n homeassistant
Setting up the GPG keyring
Downloading the image index
WARNING: Failed to download the file over HTTPs.
         The file was instead download over HTTP. A server replay attack may be possible!

 ---
 DIST  RELEASE  ARCH  VARIANT  BUILD
 ---
 Turris_OS  stable  armv7l  default  2017-01-22
 Turris_OS  stable  ppc  default  2017-01-22
 Alpine  3.4  armv7l  default  2017-01-22
 Debian  Jessie  armv7l  default  2017-01-22
 Gentoo  stable  armv7l  default  2017-01-22
 openSUSE  13.2  armv7l  default  2017-01-22
 openSUSE  42.2  armv7l  default  2017-01-22
 openSUSE  Tumbleweed  armv7l  default  2017-01-22
 Ubuntu  Xenial  armv7l  default  2017-01-22
 Ubuntu  Yakkety  armv7l  default  2017-01-22
 ---

 Distribution: Debian
 Release: Jessie
 Architecture: armv7l

 Flushing the cache...
 Downloading the image index
 Downloading the rootfs
 Downloading the metadata
 The image cache is now ready
 Unpacking the rootfs

 ---
 Distribution Debian version Jessie was just installed into your
 container.

 Content of the tarballs is provided by third party, thus there is
 no warranty of any kind.</pre>
<p>As you can see above, I chose a Debian Jessie distribution.</p>
<p>Let's start and enter the container:</p>
<pre class="literal-block">root@turris:~# lxc-start -n homeassistant
root@turris:~# lxc-attach -n homeassistant</pre>
<p>Now that we are inside the container, we can first set the root password:</p>
<pre class="literal-block">root@LXC_NAME:~# passwd
Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully</pre>
<p><em>LXC_NAME</em> is not a super nice hostname. Let's update it:</p>
<pre class="literal-block">root@LXC_NAME:~# hostnamectl set-hostname homeassistant
Failed to create bus connection: No such file or directory</pre>
<p>Ok... We have to <a class="reference external" href="http://serverfault.com/questions/685837/how-to-set-the-hostname-for-a-debian-jessie-system">install dbus</a>.
While we are at it, let's install vim because
we'll need it to edit the homeassistant configuration:</p>
<pre class="literal-block">root@LXC_NAME:~# apt-get update
root@LXC_NAME:~# apt-get upgrade
root@LXC_NAME:~# apt-get install -y dbus vim</pre>
<p>Setting the hostname now works properly:</p>
<pre class="literal-block">root@LXC_NAME:~# hostnamectl set-hostname homeassistant</pre>
<p>We can exit and enter the container again to see the change:</p>
<pre class="literal-block">root@LXC_NAME:~# exit
root@turris:~# lxc-attach -n homeassistant
root@homeassistant:~#</pre>
</div>
<div class="section" id="install-home-assistant">
<h2>Install Home Assistant</h2>
<p>Next, we just have to follow the <a class="reference external" href="https://home-assistant.io/getting-started/installation-virtualenv/">Home Assistant installation instructions</a>.
They are well detailed. I'll just quickly repeat them here to make it
easier to follow but you should refer to the official page for any update:</p>
<pre class="literal-block">root@homeassistant:~# apt-get install python-pip python3-dev
root@homeassistant:~# pip install --upgrade virtualenv
root@homeassistant:~# adduser --system homeassistant
root@homeassistant:~# mkdir /srv/homeassistant
root@homeassistant:~# chown homeassistant /srv/homeassistant
root@homeassistant:~# su -s /bin/bash homeassistant
homeassistant@homeassistant:/root$ virtualenv -p python3 /srv/homeassistant
homeassistant@homeassistant:/root$ source /srv/homeassistant/bin/activate
(homeassistant) homeassistant@homeassistant:/root$ pip3 install --upgrade homeassistant</pre>
<p>Just run <em>hass</em> to start the application and create the default
configuration:</p>
<pre class="literal-block">(homeassistant) homeassistant@homeassistant:/root$ hass</pre>
<p>Press CTRL-C to exit.
Check the created configuration file:
<cite>/home/homeassistant/.homeassistant/configuration.yaml</cite>.</p>
<p>You can comment out the <cite>introduction:</cite> line:</p>
<pre class="literal-block"># Show links to resources in log and frontend
#introduction:</pre>
</div>
<div class="section" id="add-a-switch-to-home-assistant">
<h2>Add a switch to Home Assistant</h2>
<p>To start and stop our VPN we define a <a class="reference external" href="https://home-assistant.io/components/switch.command_line/">Command Line Switch</a> that
triggers the openvpn script on the router.
Add the following at the end of the file:</p>
<pre class="literal-block">switch:
  platform: command_line
  switches:
        atv_vpn:
          command_on: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn start"'
          command_off: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn stop"'
          friendly_name: ATV4 VPN</pre>
<p>The LXC container is just like another computer (a virtual one) on the local network.
To access the router, we have to ssh to it. For this to work without
requesting a password, we have to generate a ssh key and add the public
key to the authorized_keys file on the router:</p>
<pre class="literal-block">homeassistant@homeassistant:~$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/homeassistant/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/homeassistant/.ssh/id_rsa.
Your public key has been saved in /home/homeassistant/.ssh/id_rsa.pub.</pre>
<p>Copy the content of <cite>/home/homeassistant/.ssh/id_rsa.pub</cite> to
<cite>/root/.ssh/authorized_keys</cite> (on the router not inside the container).</p>
<p>With this configuration, the switch will always be off when you restart
Home Assistant. It won't know either if you change the state using the
command line or LuCI web interface.
This can be solved by adding the optional <cite>command_state</cite> line. The
command shall return a result code <em>0</em> if the switch is on.
The openvpn init script on the Turris Omnia doesn't take "status" as
argument. An easy way to check if openvpn is running is to use pgrep.
Our new configuration becomes:</p>
<pre class="literal-block">switch:
  platform: command_line
  switches:
        atv_vpn:
          command_on: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn start"'
          command_off: 'ssh root@&lt;router IP&gt; "/etc/init.d/openvpn stop"'
          command_state: 'ssh root@&lt;router IP&gt; "pgrep /usr/sbin/openvpn"'
          friendly_name: ATV4 VPN</pre>
<p>That's it. The switch state will now properly be updated
even if the VPN is started or stopped without using the application.</p>
<p>If you go to <em>http://&lt;container IP&gt;:8123</em>, you should see something like
that:</p>
<img alt="/images/hass_home.png" src="images/hass_home.png">
</div>
<div class="section" id="automatically-start-home-assistant">
<h2>Automatically start Home Assistant</h2>
<p>Let's configure <a class="reference external" href="https://home-assistant.io/getting-started/autostart-systemd/">systemd</a> to automatically
start the application.
Create the file <cite>/etc/systemd/system/home-assistant@homeassistant.service</cite>:</p>
<pre class="literal-block">root@homeassistant:~# cat &lt;&lt;EOF &gt;&gt; /etc/systemd/system/home-assistant@homeassistant.service
[Unit]
Description=Home Assistant
After=network.target

[Service]
Type=simple
User=homeassistant
ExecStart=/srv/homeassistant/bin/hass -c "/home/homeassistant/.homeassistant"

[Install]
WantedBy=multi-user.target
EOF</pre>
<p>Enable and launch Home Assistant:</p>
<pre class="literal-block">root@homeassistant:~# systemctl --system daemon-reload
root@homeassistant:~# systemctl enable home-assistant@homeassistant
Created symlink from /etc/systemd/system/multi-user.target.wants/home-assistant@homeassistant.service to /etc/systemd/system/home-assistant@homeassistant.service.
root@homeassistant:~# systemctl start home-assistant@homeassistant</pre>
<p>You can check the logs with:</p>
<pre class="literal-block">root@homeassistant:~# journalctl -f -u home-assistant@homeassistant</pre>
<p>We just have to make sure the container starts automatically when we
reboot the router.
Set the following in <cite>/etc/config/lxc-auto</cite>:</p>
<pre class="literal-block">root@turris:~# cat /etc/config/lxc-auto
config container
  option name homeassistant
  option timeout 60</pre>
</div>
<div class="section" id="make-it-easy-to-access-home-assistant">
<h2>Make it easy to access Home Assistant</h2>
<p>There is one more thing we want to do: assign a fixed IP to the container.
This can be done like for any machines on the LAN via the <em>DHCP and DNS</em> settings in LuCI interface.
In <em>Static Leases</em>, assign a fixed IP to the container MAC address.</p>
<p>Now that the container has a fixed IP, go to <em>http://&lt;container IP&gt;:8123</em> and
create a bookmark or add an icon to your phone and tablet home screen.
This makes it easy for anyone at home to turn the VPN on and off!</p>
<img alt="/images/hass_icon.png" src="images/hass_icon.png">
</div>
</div>
    </div>
    </article>
</div>

        <ul class="pager postindexpager clearfix">
<li class="previous"><a href="." rel="prev">Newer posts</a></li>
            <li class="next"><a href="index-1.html" rel="next">Older posts</a></li>
        </ul>
<script>var disqus_shortname="tchutchut";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents Â© 2020         <a href="mailto:beenje@gmail.com">Benjamin Bertrand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>
            
            
        </footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99836987-1', 'auto');
  ga('set', 'anonymizeIP', true);
  ga('send', 'pageview');

</script>
</body>
</html>
